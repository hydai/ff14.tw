# 寶圖搜尋器 - 房間協作功能 BDD 規格書

## 功能概述
允許多位玩家透過共享房間代號來協同管理寶圖清單，實現即時同步的團隊協作功能。

## 核心概念
- **房主管理制**：房間建立者（房主）擁有移除成員的權限，確保房間管理秩序
- **信任基礎**：除了成員管理外，不設置過多限制，相信使用者會正確使用
- **即時同步**：使用智慧輪詢機制達到準即時的協作體驗
- **資料完整性**：確保寶圖歸屬的正確性，避免誤導性的資料

## 詳細規格

### Feature: 建立協作房間
```gherkin
Feature: 建立協作房間
  作為一個尋寶團隊的成員
  我想要建立一個協作房間
  以便和團隊成員共享寶圖清單

  Background:
    Given 我在寶圖搜尋器頁面
    And 我尚未加入任何房間

  Scenario: 成功建立新房間
    When 我點擊「建立新房間」按鈕
    Then 系統應該生成一個6位英數字的房間代號
    And 顯示房間代號供我分享
    And 自動將我加入該房間
    And 分配給我「光之戰士1」的預設暱稱
    And 標記我為房主（顯示皇冠圖示 👑）
    And 在網址列顯示房間參數 "?room=<房間代號>"

  Scenario: 建立房間前的本地資料處理
    Given 我有 5 張本地寶圖
    When 我嘗試建立新房間
    Then 系統應該提示我清空本地清單以確保資料準確性
    And 我可以選擇清空或保留本地清單

  Scenario: 防止重複建立房間
    Given 我已經建立過一個房間
    When 我嘗試建立新房間
    Then 系統應該提示「您已有房間，請先離開現有房間」

  Scenario: 瀏覽器限制
    Given 我的瀏覽器已經有房間記錄在 localStorage
    When 我嘗試建立新房間
    Then 系統應該提示「此瀏覽器已有房間記錄，請先清除或使用其他瀏覽器」
```

### Feature: 加入現有房間
```gherkin
Feature: 加入現有房間
  作為一個尋寶團隊的成員
  我想要加入現有的協作房間
  以便與其他成員共享寶圖資訊

  Background:
    Given 我在寶圖搜尋器頁面
    And 我尚未加入任何房間

  Scenario: 成功加入房間
    Given 存在一個有效的房間 "A3B7K9"
    And 房間目前有 3 位成員
    When 我點擊「加入房間」按鈕
    And 輸入房間代號 "A3B7K9"
    Then 我應該成功加入房間
    And 系統分配給我「光之戰士4」的暱稱
    And 我能看到現有的寶圖清單
    And 房間資訊顯示「4/8人」

  Scenario: 加入已滿房間
    Given 存在一個房間已有 8 位成員
    When 我嘗試加入該房間
    Then 系統應該提示「房間已滿（8/8）」

  Scenario: 加入不存在的房間
    When 我輸入不存在的房間代號 "ZZZZZZ"
    Then 系統應該提示「房間不存在或已過期」

  Scenario: 透過 URL 參數加入
    Given URL 包含參數 "?room=A3B7K9"
    When 我載入頁面
    Then 系統應該自動嘗試加入房間 "A3B7K9"
    
  Scenario: 加入房間前的本地資料處理
    Given 我有 3 張本地寶圖
    When 我嘗試加入房間
    Then 系統應該提示我清空本地清單以確保資料準確性
    And 說明本地寶圖可能被錯誤歸屬
    
  Scenario: 避免重複加入
    Given 我已經在房間 "A3B7K9" 中
    And 我重新整理頁面
    When 頁面載入完成
    Then 系統應該恢復我的會話而非建立新成員
```

### Feature: 暱稱管理
```gherkin
Feature: 暱稱管理
  作為房間成員
  我想要自訂我的暱稱
  以便其他成員能識別我

  Scenario: 修改暱稱
    Given 我已加入房間
    And 我的預設暱稱是「光之戰士3」
    When 我點擊暱稱旁的編輯按鈕
    And 輸入新暱稱「拉拉肥」
    Then 我的暱稱應該更新為「拉拉肥」
    And 其他成員應該看到我的新暱稱
    And localStorage 應該儲存我的新暱稱
    And 操作歷史應該記錄「拉拉肥 更新了暱稱」

  Scenario: 斷線重連保持暱稱
    Given 我的暱稱是「拉拉肥」
    When 我重新整理頁面
    And 重新加入同一個房間
    Then 我的暱稱應該仍然是「拉拉肥」
```

### Feature: 寶圖清單協作
```gherkin
Feature: 寶圖清單協作
  作為房間成員
  我想要新增或移除寶圖
  以便團隊能共同管理寶圖清單

  Background:
    Given 我已加入房間 "A3B7K9"
    And 房間內有 3 位成員

  Scenario: 新增寶圖
    Given 清單中有 3 張寶圖
    When 我選擇一張 G12 地圖
    And 點擊加入清單
    Then 清單應該顯示 4 張寶圖
    And 新寶圖應該標註「由 拉拉肥 加入」
    And 其他成員應該在 3 秒內看到新寶圖

  Scenario: 移除寶圖
    Given 清單中有寶圖「G12 - (15.2, 23.1)」
    When 我點擊該寶圖的移除按鈕
    And 確認移除操作
    Then 該寶圖應該從清單中消失
    And 操作歷史應該記錄「拉拉肥 移除了 G12 - (15.2, 23.1)」

  Scenario: 達到寶圖上限
    Given 清單中已有 8 張寶圖
    When 我嘗試新增第 9 張寶圖
    Then 系統應該提示「清單已滿（8/8）」

  Scenario: 並發移除衝突
    Given 清單中有寶圖「G12 - (15.2, 23.1)」
    And 另一位成員同時移除了該寶圖
    When 我嘗試移除同一張寶圖
    Then 系統應該提示「該寶圖已被移除」
```

### Feature: 即時同步機制
```gherkin
Feature: 即時同步機制
  作為房間成員
  我想要看到其他成員的即時操作
  以便保持資訊同步

  Background:
    Given 我已加入房間
    And 啟用智慧輪詢機制

  Scenario: 正常活動時的同步
    Given 我正在活躍操作
    When 其他成員新增一張寶圖
    Then 我應該在 2-3 秒內看到更新

  Scenario: 操作後立即同步
    When 我新增或移除寶圖
    Then 系統應該立即發起同步請求
    And 樂觀更新本地顯示

  Scenario: 閒置降頻
    Given 我已經 30 秒沒有操作
    When 系統進入閒置模式
    Then 輪詢頻率應該降低到每 10 秒一次

  Scenario: 同步失敗處理
    Given 網路連線不穩定
    When 同步請求失敗
    Then 系統應該自動重試最多 3 次
    And 如果仍然失敗，顯示「同步失敗，請檢查網路連線」
```

### Feature: 房間生命週期
```gherkin
Feature: 房間生命週期
  作為系統管理機制
  確保房間資源的有效利用
  避免過期資料累積

  Scenario: 活動延長壽命
    Given 房間建立於 1月1日 10:00
    When 1月1日 15:00 有成員進行操作
    Then 房間過期時間應該更新為 1月2日 15:00

  Scenario: 房間過期
    Given 房間最後活動時間是 1月1日 10:00
    When 時間到達 1月2日 10:01
    Then 房間資料應該被自動刪除
    And 房間代號可以被重新使用

  Scenario: 查看過期房間
    Given 房間已經過期
    When 成員嘗試存取房間
    Then 顯示「該房間已失效」
    And 自動清除本地房間資料
```

### Feature: 離開房間
```gherkin
Feature: 離開房間
  作為房間成員
  我想要能夠離開房間
  並選擇如何處理我的本地資料

  Scenario: 主動離開房間
    Given 我在房間中
    And 清單有 5 張寶圖
    When 我點擊「離開房間」
    Then 系統應該詢問「是否保留本地寶圖清單？」
    And 系統應該通知伺服器我已離開
    
  Scenario: 選擇保留清單
    When 我選擇「保留」
    Then 我應該退出房間
    And 本地清單保持 5 張寶圖
    And 可以繼續單機使用
    And 操作歷史應該記錄「[暱稱] 離開了房間」

  Scenario: 選擇清空清單
    When 我選擇「清空」
    Then 我應該退出房間
    And 本地清單應該被清空
```

### Feature: 操作歷史
```gherkin
Feature: 操作歷史
  作為房間成員
  我想要查看操作歷史
  以便追蹤團隊的活動

  Background:
    Given 我在房間中
    And 操作歷史儲存在 localStorage

  Scenario: 記錄操作
    When 光之戰士2 新增了 G12 地圖
    Then 操作歷史應該顯示「光之戰士2 新增了 G12 - (15.2, 23.1)」
    And 顯示操作時間

  Scenario: 歷史上限
    Given 操作歷史已有 50 筆記錄
    When 新增第 51 筆操作
    Then 最舊的記錄應該被移除
    And 保持最新的 50 筆記錄

  Scenario: 房間過期清理
    Given 房間已過期
    When 系統清理過期資料
    Then 相關的操作歷史也應該被清除
```

### Feature: 成員管理
```gherkin
Feature: 成員管理
  作為房主
  我想要管理房間成員
  以確保房間秩序

  Background:
    Given 我是房主（顯示皇冠圖示）
    And 房間有 4 位成員

  Scenario: 移除成員
    Given 「光之戰士3」離線很久
    When 我點擊該成員旁的移除按鈕（×）
    And 確認移除操作
    Then 該成員應該被移出房間
    And 操作歷史應該記錄「房主 將 光之戰士3 移出房間」

  Scenario: 非房主無法移除
    Given 我不是房主
    When 我查看成員列表
    Then 我不應該看到移除按鈕

  Scenario: 無法移除房主
    Given 我是房主
    When 我查看自己的名稱
    Then 我不應該看到移除按鈕
```

## 技術實作要點

### Cloudflare KV 資料結構
```javascript
// 房間資料 (key: room:<房間代號>)
{
  "roomCode": "A3B7K9",
  "createdAt": "2024-01-01T10:00:00Z",
  "lastActivityAt": "2024-01-01T15:30:00Z",
  "members": [
    { "id": 1, "nickname": "光之戰士1", "joinedAt": "2024-01-01T10:00:00Z" },
    { "id": 2, "nickname": "拉拉肥", "joinedAt": "2024-01-01T10:05:00Z" }
  ],
  "treasureMaps": [
    {
      "id": "map_1",
      "type": "G12",
      "x": 15.2,
      "y": 23.1,
      "zone": "厄爾庇斯",
      "addedBy": 2,
      "addedAt": "2024-01-01T10:30:00Z"
    }
  ]
}
```

### 智慧輪詢策略
- 活躍期：每 2 秒輪詢
- 操作觸發：立即輪詢
- 閒置期（30秒後）：每 10 秒輪詢
- 重新活躍：恢復 2 秒輪詢

### 防濫用機制
- localStorage 記錄已建立/加入的房間
- 限制每個瀏覽器只能在一個房間
- 簡單的瀏覽器指紋識別

### 錯誤處理
- 網路錯誤：最多重試 3 次
- 並發衝突：顯示友善錯誤訊息
- 房間過期：自動清理本地狀態

## 介面設計建議

### 房間狀態顯示
```
┌─────────────────────────────────┐
│ 房間：A3B7K9  (4/8人)           │
│ 最後更新：2 分鐘前              │
│ 剩餘時間：23小時42分            │
│ 您的暱稱：拉拉肥 [編輯]         │
│ 房間成員：[光之戰士1👑] [拉拉肥] │
└─────────────────────────────────┘
```

### 操作按鈕
- 未加入房間時：[建立新房間] [加入房間]
- 已加入房間時：[離開房間] [複製房間代號]

### 寶圖項目顯示
```
G12 - 厄爾庇斯 (15.2, 23.1)
由 拉拉肥 加入 • 5分鐘前 [移除]
```

## 安全考量
- 房間代號使用 6 位英數字（62^6 種組合）
- 不儲存敏感資料
- 24 小時自動過期機制
- 基於信任的設計，但保有基本權限控制（房主管理）
- 成員 ID 使用時間戳 + 隨機數，避免競爭條件
- CORS 白名單限制，只允許 ff14.tw 相關網域
- 資料歸屬完整性，避免本地寶圖被錯誤歸屬

## API 優化
- 加入房間不再需要先 GET 檢查，直接 POST /join
- 重用輔助函數減少程式碼重複
- 使用正規表達式路由解析，提高可維護性

## CSS 最佳實踐
- 避免過度使用 !important
- 使用高特異性選擇器代替 !important
- 保持 CSS 級聯特性，提高可維護性