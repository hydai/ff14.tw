class FauxHollowsFoxes {
    static CONSTANTS = {
        BOARD_SIZE: 6,
        TOTAL_CELLS: 36,
        MAX_CLICKS: 11,
        PERCENTAGE: 100,
        SCORES: {
            SWORD: 100,
            CHEST: 60,
            FOX: 20
        },
        SHAPES: {
            SWORD: { width: 2, height: 3 }, // Can be rotated to 3x2
            CHEST: { width: 2, height: 2 },
            FOX: { width: 1, height: 1 }
        },
        CELL_VALUES: {
            EMPTY: 0,
            OBSTACLE: 1,
            SWORD: 2,
            CHEST: 3,
            FOX_OR_EMPTY: 4
        }
    };

    static BOARD_DATA = [
        [[4,0,0,4,3,3],[0,0,0,1,3,3],[0,1,0,0,1,0],[0,0,0,0,0,4],[0,2,2,2,1,4],[1,2,2,2,0,0]],
        [[1,0,0,0,0,4],[2,2,0,1,0,0],[2,2,0,0,0,0],[2,2,0,0,1,4],[0,1,0,1,3,3],[0,4,4,0,3,3]],
        [[0,0,2,2,2,1],[4,1,2,2,2,0],[4,0,0,0,0,0],[0,1,0,0,1,0],[3,3,1,0,0,0],[3,3,4,0,0,4]],
        [[3,3,0,4,4,0],[3,3,1,0,1,0],[4,1,0,0,2,2],[0,0,0,0,2,2],[0,0,1,0,2,2],[4,0,0,0,0,1]],
        [[4,0,0,4,0,0],[0,0,0,1,0,0],[0,1,3,3,1,0],[0,0,3,3,0,4],[0,2,2,2,1,4],[1,2,2,2,0,0]],
        [[1,0,0,0,0,4],[2,2,0,1,0,0],[2,2,3,3,0,0],[2,2,3,3,1,4],[0,1,0,1,0,0],[0,4,4,0,0,0]],
        [[0,0,2,2,2,1],[4,1,2,2,2,0],[4,0,3,3,0,0],[0,1,3,3,1,0],[0,0,1,0,0,0],[0,0,4,0,0,4]],
        [[0,0,0,4,4,0],[0,0,1,0,1,0],[4,1,3,3,2,2],[0,0,3,3,2,2],[0,0,1,0,2,2],[4,0,0,0,0,1]],
        [[0,0,0,0,3,3],[0,0,0,1,3,3],[0,1,0,0,1,0],[4,2,2,2,4,0],[4,2,2,2,1,0],[1,0,0,4,0,0]],
        [[1,4,4,0,0,0],[0,2,2,1,0,0],[0,2,2,0,0,0],[4,2,2,0,1,0],[0,1,4,1,3,3],[0,0,0,0,3,3]],
        [[0,0,4,0,0,1],[0,1,2,2,2,4],[0,4,2,2,2,4],[0,1,0,0,1,0],[3,3,1,0,0,0],[3,3,0,0,0,0]],
        [[3,3,0,0,0,0],[3,3,1,4,1,0],[0,1,0,2,2,4],[0,0,0,2,2,0],[0,0,1,2,2,0],[0,0,0,4,4,1]],
        [[0,3,3,0,0,0],[0,3,3,1,0,0],[0,1,0,0,1,0],[4,2,2,2,4,0],[4,2,2,2,1,0],[1,0,0,4,0,0]],
        [[1,4,4,0,0,0],[0,2,2,1,3,3],[0,2,2,0,3,3],[4,2,2,0,1,0],[0,1,4,1,0,0],[0,0,0,0,0,0]],
        [[0,0,4,0,0,1],[0,1,2,2,2,4],[0,4,2,2,2,4],[0,1,0,0,1,0],[0,0,1,3,3,0],[0,0,0,3,3,0]],
        [[0,0,0,0,0,0],[0,0,1,4,1,0],[0,1,0,2,2,4],[3,3,0,2,2,0],[3,3,1,2,2,0],[0,0,0,4,4,1]],
        [[0,0,0,0,3,3],[0,0,0,1,3,3],[0,1,4,0,1,0],[2,2,2,4,0,0],[2,2,2,4,1,0],[1,0,0,0,0,4]],
        [[1,2,2,0,0,0],[0,2,2,1,0,0],[0,2,2,4,0,0],[0,4,4,0,1,0],[0,1,0,1,3,3],[4,0,0,0,3,3]],
        [[4,0,0,0,0,1],[0,1,4,2,2,2],[0,0,4,2,2,2],[0,1,0,4,1,0],[3,3,1,0,0,0],[3,3,0,0,0,0]],
        [[3,3,0,0,0,4],[3,3,1,0,1,0],[0,1,0,4,4,0],[0,0,4,2,2,0],[0,0,1,2,2,0],[0,0,0,2,2,1]],
        [[0,3,3,0,0,0],[0,3,3,1,0,0],[0,1,4,0,1,0],[2,2,2,4,0,0],[2,2,2,4,1,0],[1,0,0,0,0,4]],
        [[1,2,2,0,0,0],[0,2,2,1,3,3],[0,2,2,4,3,3],[0,4,4,0,1,0],[0,1,0,1,0,0],[4,0,0,0,0,0]],
        [[4,0,0,0,0,1],[0,1,4,2,2,2],[0,0,4,2,2,2],[0,1,0,4,1,0],[0,0,1,3,3,0],[0,0,0,3,3,0]],
        [[0,0,0,0,0,4],[0,0,1,0,1,0],[0,1,0,4,4,0],[3,3,4,2,2,0],[3,3,1,2,2,0],[0,0,0,2,2,1]],
        [[4,3,3,4,0,0],[0,3,3,1,0,0],[0,1,0,0,1,0],[0,0,2,2,0,4],[0,0,2,2,1,4],[1,0,2,2,0,0]],
        [[1,0,0,0,0,4],[0,0,0,1,3,3],[2,2,2,0,3,3],[2,2,2,0,1,4],[0,1,0,1,0,0],[0,4,4,0,0,0]],
        [[0,0,2,2,0,1],[4,1,2,2,0,0],[4,0,2,2,0,0],[0,1,0,0,1,0],[0,0,1,3,3,0],[0,0,4,3,3,4]],
        [[0,0,0,4,4,0],[0,0,1,0,1,0],[4,1,0,2,2,2],[3,3,0,2,2,2],[3,3,1,0,0,0],[4,0,0,0,0,1]],
        [[4,0,0,4,0,0],[0,0,0,1,0,0],[0,1,0,0,1,0],[3,3,2,2,0,4],[3,3,2,2,1,4],[1,0,2,2,0,0]],
        [[1,3,3,0,0,4],[0,3,3,1,0,0],[2,2,2,0,0,0],[2,2,2,0,1,4],[0,1,0,1,0,0],[0,4,4,0,0,0]],
        [[0,0,2,2,0,1],[4,1,2,2,3,3],[4,0,2,2,3,3],[0,1,0,0,1,0],[0,0,1,0,0,0],[0,0,4,0,0,4]],
        [[0,0,0,4,4,0],[0,0,1,0,1,0],[4,1,0,2,2,2],[0,0,0,2,2,2],[0,0,1,3,3,0],[4,0,0,3,3,1]],
        [[0,0,0,0,3,3],[0,0,0,1,3,3],[0,1,4,0,1,0],[0,2,2,4,0,0],[0,2,2,4,1,0],[1,2,2,0,0,4]],
        [[1,0,0,0,0,0],[2,2,2,1,0,0],[2,2,2,4,0,0],[0,4,4,0,1,0],[0,1,0,1,3,3],[4,0,0,0,3,3]],
        [[4,0,0,2,2,1],[0,1,4,2,2,0],[0,0,4,2,2,0],[0,1,0,4,1,0],[3,3,1,0,0,0],[3,3,0,0,0,0]],
        [[3,3,0,0,0,4],[3,3,1,0,1,0],[0,1,0,4,4,0],[0,0,4,2,2,2],[0,0,1,2,2,2],[0,0,0,0,0,1]],
        [[3,3,0,0,0,0],[3,3,0,1,0,0],[0,1,4,0,1,0],[0,2,2,4,0,0],[0,2,2,4,1,0],[1,2,2,0,0,4]],
        [[1,0,0,0,3,3],[2,2,2,1,3,3],[2,2,2,4,0,0],[0,4,4,0,1,0],[0,1,0,1,0,0],[4,0,0,0,0,0]],
        [[4,0,0,2,2,1],[0,1,4,2,2,0],[0,0,4,2,2,0],[0,1,0,4,1,0],[0,0,1,0,3,3],[0,0,0,0,3,3]],
        [[0,0,0,0,0,4],[0,0,1,0,1,0],[0,1,0,4,4,0],[0,0,4,2,2,2],[3,3,1,2,2,2],[3,3,0,0,0,1]],
        [[0,0,0,0,3,3],[0,0,0,1,3,3],[4,1,2,2,1,4],[0,0,2,2,0,0],[0,0,2,2,1,0],[1,4,0,0,4,0]],
        [[1,0,0,4,0,0],[4,0,0,1,0,0],[0,2,2,2,0,0],[0,2,2,2,1,0],[4,1,0,1,3,3],[0,0,0,4,3,3]],
        [[0,4,0,0,4,1],[0,1,2,2,0,0],[0,0,2,2,0,0],[4,1,2,2,1,4],[3,3,1,0,0,0],[3,3,0,0,0,0]],
        [[3,3,4,0,0,0],[3,3,1,0,1,4],[0,1,2,2,2,0],[0,0,2,2,2,0],[0,0,1,0,0,4],[0,0,4,0,0,1]],
        [[3,3,0,0,0,0],[3,3,0,1,0,0],[4,1,2,2,1,4],[0,0,2,2,0,0],[0,0,2,2,1,0],[1,4,0,0,4,0]],
        [[1,0,0,4,3,3],[4,0,0,1,3,3],[0,2,2,2,0,0],[0,2,2,2,1,0],[4,1,0,1,0,0],[0,0,0,4,0,0]],
        [[0,4,0,0,4,1],[0,1,2,2,0,0],[0,0,2,2,0,0],[4,1,2,2,1,4],[0,0,1,0,3,3],[0,0,0,0,3,3]],
        [[0,0,4,0,0,0],[0,0,1,0,1,4],[0,1,2,2,2,0],[0,0,2,2,2,0],[3,3,1,0,0,4],[3,3,4,0,0,1]],
        [[2,2,2,0,0,0],[2,2,2,1,0,0],[4,1,0,0,1,4],[3,3,0,0,0,0],[3,3,0,0,1,0],[1,4,0,0,4,0]],
        [[1,3,3,4,2,2],[4,3,3,1,2,2],[0,0,0,0,2,2],[0,0,0,0,1,0],[4,1,0,1,0,0],[0,0,0,4,0,0]],
        [[0,4,0,0,4,1],[0,1,0,0,3,3],[0,0,0,0,3,3],[4,1,0,0,1,4],[0,0,1,2,2,2],[0,0,0,2,2,2]],
        [[0,0,4,0,0,0],[0,0,1,0,1,4],[0,1,0,0,0,0],[2,2,0,0,0,0],[2,2,1,3,3,4],[2,2,4,3,3,1]],
        [[2,2,2,0,0,0],[2,2,2,1,0,0],[4,1,0,0,1,4],[0,0,0,0,0,0],[0,0,3,3,1,0],[1,4,3,3,4,0]],
        [[1,0,0,4,2,2],[4,0,0,1,2,2],[3,3,0,0,2,2],[3,3,0,0,1,0],[4,1,0,1,0,0],[0,0,0,4,0,0]],
        [[0,4,3,3,4,1],[0,1,3,3,0,0],[0,0,0,0,0,0],[4,1,0,0,1,4],[0,0,1,2,2,2],[0,0,0,2,2,2]],
        [[0,0,4,0,0,0],[0,0,1,0,1,4],[0,1,0,0,3,3],[2,2,0,0,3,3],[2,2,1,0,0,4],[2,2,4,0,0,1]],
        [[2,2,2,0,0,0],[2,2,2,1,0,0],[0,1,0,0,1,0],[4,0,0,0,4,0],[4,3,3,0,1,0],[1,3,3,4,0,0]],
        [[1,4,4,0,2,2],[3,3,0,1,2,2],[3,3,0,0,2,2],[4,0,0,0,1,0],[0,1,4,1,0,0],[0,0,0,0,0,0]],
        [[0,0,4,3,3,1],[0,1,0,3,3,4],[0,4,0,0,0,4],[0,1,0,0,1,0],[0,0,1,2,2,2],[0,0,0,2,2,2]],
        [[0,0,0,0,0,0],[0,0,1,4,1,0],[0,1,0,0,0,4],[2,2,0,0,3,3],[2,2,1,0,3,3],[2,2,0,4,4,1]],
        [[2,2,2,0,0,0],[2,2,2,1,0,0],[0,1,3,3,1,0],[4,0,3,3,4,0],[4,0,0,0,1,0],[1,0,0,4,0,0]],
        [[1,4,4,0,2,2],[0,0,0,1,2,2],[0,0,3,3,2,2],[4,0,3,3,1,0],[0,1,4,1,0,0],[0,0,0,0,0,0]],
        [[0,0,4,0,0,1],[0,1,0,0,0,4],[0,4,3,3,0,4],[0,1,3,3,1,0],[0,0,1,2,2,2],[0,0,0,2,2,2]],
        [[0,0,0,0,0,0],[0,0,1,4,1,0],[0,1,3,3,0,4],[2,2,3,3,0,0],[2,2,1,0,0,0],[2,2,0,4,4,1]],
        [[0,0,4,0,2,2],[0,0,0,1,2,2],[1,4,0,0,2,2],[4,0,1,4,0,1],[0,0,0,1,3,3],[0,0,0,0,3,3]],
        [[0,0,4,1,0,0],[0,0,0,4,0,0],[0,0,1,0,0,4],[0,1,4,0,1,0],[3,3,0,2,2,2],[3,3,1,2,2,2]],
        [[3,3,0,0,0,0],[3,3,1,0,0,0],[1,0,4,1,0,4],[2,2,0,0,4,1],[2,2,1,0,0,0],[2,2,0,4,0,0]],
        [[2,2,2,1,3,3],[2,2,2,0,3,3],[0,1,0,4,1,0],[4,0,0,1,0,0],[0,0,4,0,0,0],[0,0,1,4,0,0]],
        [[0,0,4,0,2,2],[0,0,0,1,2,2],[1,4,0,0,2,2],[4,0,1,4,0,1],[3,3,0,1,0,0],[3,3,0,0,0,0]],
        [[3,3,4,1,0,0],[3,3,0,4,0,0],[0,0,1,0,0,4],[0,1,4,0,1,0],[0,0,0,2,2,2],[0,0,1,2,2,2]],
        [[0,0,0,0,3,3],[0,0,1,0,3,3],[1,0,4,1,0,4],[2,2,0,0,4,1],[2,2,1,0,0,0],[2,2,0,4,0,0]],
        [[2,2,2,1,0,0],[2,2,2,0,0,0],[0,1,0,4,1,0],[4,0,0,1,0,0],[0,0,4,0,3,3],[0,0,1,4,3,3]],
        [[3,3,0,0,2,2],[3,3,0,1,2,2],[1,0,4,4,2,2],[0,0,1,0,0,1],[0,0,4,1,4,0],[0,0,0,0,0,0]],
        [[0,0,0,1,3,3],[0,0,0,0,3,3],[0,4,1,4,0,0],[0,1,0,4,1,0],[0,4,0,2,2,2],[0,0,1,2,2,2]],
        [[0,0,0,0,0,0],[0,4,1,4,0,0],[1,0,0,1,0,0],[2,2,4,4,0,1],[2,2,1,0,3,3],[2,2,0,0,3,3]],
        [[2,2,2,1,0,0],[2,2,2,0,4,0],[0,1,4,0,1,0],[0,0,4,1,4,0],[3,3,0,0,0,0],[3,3,1,0,0,0]],
        [[0,0,0,0,2,2],[0,0,0,1,2,2],[1,0,4,4,2,2],[3,3,1,0,0,1],[3,3,4,1,4,0],[0,0,0,0,0,0]],
        [[0,3,3,1,0,0],[0,3,3,0,0,0],[0,4,1,4,0,0],[0,1,0,4,1,0],[0,4,0,2,2,2],[0,0,1,2,2,2]],
        [[0,0,0,0,0,0],[0,4,1,4,3,3],[1,0,0,1,3,3],[2,2,4,4,0,1],[2,2,1,0,0,0],[2,2,0,0,0,0]],
        [[2,2,2,1,0,0],[2,2,2,0,4,0],[0,1,4,0,1,0],[0,0,4,1,4,0],[0,0,0,3,3,0],[0,0,1,3,3,0]],
        [[3,3,4,0,0,0],[3,3,0,1,0,0],[1,4,0,0,0,0],[4,0,1,4,0,1],[2,2,2,1,0,0],[2,2,2,0,0,0]],
        [[2,2,4,1,3,3],[2,2,0,4,3,3],[2,2,1,0,0,4],[0,1,4,0,1,0],[0,0,0,0,0,0],[0,0,1,0,0,0]],
        [[0,0,0,2,2,2],[0,0,1,2,2,2],[1,0,4,1,0,4],[0,0,0,0,4,1],[0,0,1,0,3,3],[0,0,0,4,3,3]],
        [[0,0,0,1,0,0],[0,0,0,0,0,0],[0,1,0,4,1,0],[4,0,0,1,2,2],[3,3,4,0,2,2],[3,3,1,4,2,2]],
        [[0,0,4,0,0,0],[0,0,0,1,3,3],[1,4,0,0,3,3],[4,0,1,4,0,1],[2,2,2,1,0,0],[2,2,2,0,0,0]],
        [[2,2,4,1,0,0],[2,2,0,4,0,0],[2,2,1,0,0,4],[0,1,4,0,1,0],[0,0,0,3,3,0],[0,0,1,3,3,0]],
        [[0,0,0,2,2,2],[0,0,1,2,2,2],[1,0,4,1,0,4],[3,3,0,0,4,1],[3,3,1,0,0,0],[0,0,0,4,0,0]],
        [[0,3,3,1,0,0],[0,3,3,0,0,0],[0,1,0,4,1,0],[4,0,0,1,2,2],[0,0,4,0,2,2],[0,0,1,4,2,2]],
        [[0,0,0,0,4,0],[0,3,3,1,0,4],[1,3,3,0,4,0],[0,0,1,0,0,1],[2,2,2,1,0,0],[2,2,2,4,0,0]],
        [[2,2,0,1,0,0],[2,2,0,3,3,0],[2,2,1,3,3,0],[4,1,0,0,1,0],[0,0,0,4,0,4],[0,0,1,0,4,0]],
        [[0,0,4,2,2,2],[0,0,1,2,2,2],[1,0,0,1,0,0],[0,4,0,3,3,1],[4,0,1,3,3,0],[0,4,0,0,0,0]],
        [[0,4,0,1,0,0],[4,0,4,0,0,0],[0,1,0,0,1,4],[0,3,3,1,2,2],[0,3,3,0,2,2],[0,0,1,0,2,2]],
        [[0,0,0,0,4,0],[0,0,0,1,0,4],[1,0,0,0,4,0],[0,0,1,0,0,1],[2,2,2,1,3,3],[2,2,2,4,3,3]],
        [[2,2,0,1,0,0],[2,2,0,0,0,0],[2,2,1,0,0,0],[4,1,0,0,1,0],[3,3,0,4,0,4],[3,3,1,0,4,0]],
        [[3,3,4,2,2,2],[3,3,1,2,2,2],[1,0,0,1,0,0],[0,4,0,0,0,1],[4,0,1,0,0,0],[0,4,0,0,0,0]],
        [[0,4,0,1,3,3],[4,0,4,0,3,3],[0,1,0,0,1,4],[0,0,0,1,2,2],[0,0,0,0,2,2],[0,0,1,0,2,2]],
        [[0,0,0,0,4,0],[0,0,0,1,0,4],[1,0,0,0,4,0],[2,2,1,0,0,1],[2,2,0,1,3,3],[2,2,0,4,3,3]],
        [[2,2,2,1,0,0],[2,2,2,0,0,0],[0,0,1,0,0,0],[4,1,0,0,1,0],[3,3,0,4,0,4],[3,3,1,0,4,0]],
        [[3,3,4,0,2,2],[3,3,1,0,2,2],[1,0,0,1,2,2],[0,4,0,0,0,1],[4,0,1,0,0,0],[0,4,0,0,0,0]],
        [[0,4,0,1,3,3],[4,0,4,0,3,3],[0,1,0,0,1,4],[0,0,0,1,0,0],[0,0,0,2,2,2],[0,0,1,2,2,2]],
        [[3,3,0,0,4,0],[3,3,0,1,0,4],[1,0,0,0,4,0],[2,2,1,0,0,1],[2,2,0,1,0,0],[2,2,0,4,0,0]],
        [[2,2,2,1,3,3],[2,2,2,0,3,3],[0,0,1,0,0,0],[4,1,0,0,1,0],[0,0,0,4,0,4],[0,0,1,0,4,0]],
        [[0,0,4,0,2,2],[0,0,1,0,2,2],[1,0,0,1,2,2],[0,4,0,0,0,1],[4,0,1,0,3,3],[0,4,0,0,3,3]],
        [[0,4,0,1,0,0],[4,0,4,0,0,0],[0,1,0,0,1,4],[0,0,0,1,0,0],[3,3,0,2,2,2],[3,3,1,2,2,2]],
        [[2,2,2,0,3,3],[2,2,2,1,3,3],[1,0,4,4,0,0],[0,0,1,0,0,1],[0,0,4,1,4,0],[0,0,0,0,0,0]],
        [[0,0,0,1,2,2],[0,0,0,0,2,2],[0,4,1,4,2,2],[0,1,0,4,1,0],[0,4,0,0,3,3],[0,0,1,0,3,3]],
        [[0,0,0,0,0,0],[0,4,1,4,0,0],[1,0,0,1,0,0],[0,0,4,4,0,1],[3,3,1,2,2,2],[3,3,0,2,2,2]],
        [[3,3,0,1,0,0],[3,3,0,0,4,0],[0,1,4,0,1,0],[2,2,4,1,4,0],[2,2,0,0,0,0],[2,2,1,0,0,0]],
        [[2,2,2,0,0,0],[2,2,2,1,0,0],[1,0,4,4,0,0],[0,0,1,0,0,1],[3,3,4,1,4,0],[3,3,0,0,0,0]],
        [[3,3,0,1,2,2],[3,3,0,0,2,2],[0,4,1,4,2,2],[0,1,0,4,1,0],[0,4,0,0,0,0],[0,0,1,0,0,0]],
        [[0,0,0,0,3,3],[0,4,1,4,3,3],[1,0,0,1,0,0],[0,0,4,4,0,1],[0,0,1,2,2,2],[0,0,0,2,2,2]],
        [[0,0,0,1,0,0],[0,0,0,0,4,0],[0,1,4,0,1,0],[2,2,4,1,4,0],[2,2,0,0,3,3],[2,2,1,0,3,3]],
        [[2,2,2,4,0,0],[2,2,2,1,0,0],[1,0,0,3,3,4],[0,0,1,3,3,1],[0,0,0,1,0,0],[4,0,0,0,0,4]],
        [[4,0,0,1,2,2],[0,0,0,0,2,2],[0,0,1,0,2,2],[0,1,3,3,1,4],[0,0,3,3,0,0],[4,0,1,4,0,0]],
        [[4,0,0,0,0,4],[0,0,1,0,0,0],[1,3,3,1,0,0],[4,3,3,0,0,1],[0,0,1,2,2,2],[0,0,4,2,2,2]],
        [[0,0,4,1,0,4],[0,0,3,3,0,0],[4,1,3,3,1,0],[2,2,0,1,0,0],[2,2,0,0,0,0],[2,2,1,0,0,4]],
        [[2,2,2,4,0,0],[2,2,2,1,0,0],[1,0,0,0,0,4],[0,0,1,0,0,1],[0,3,3,1,0,0],[4,3,3,0,0,4]],
        [[4,0,0,1,2,2],[3,3,0,0,2,2],[3,3,1,0,2,2],[0,1,0,0,1,4],[0,0,0,0,0,0],[4,0,1,4,0,0]],
        [[4,0,0,3,3,4],[0,0,1,3,3,0],[1,0,0,1,0,0],[4,0,0,0,0,1],[0,0,1,2,2,2],[0,0,4,2,2,2]],
        [[0,0,4,1,0,4],[0,0,0,0,0,0],[4,1,0,0,1,0],[2,2,0,1,3,3],[2,2,0,0,3,3],[2,2,1,0,0,4]],
        [[0,2,2,4,3,3],[0,2,2,1,3,3],[1,2,2,0,0,4],[0,0,1,0,0,1],[0,0,0,1,0,0],[4,0,0,0,0,4]],
        [[4,0,0,1,0,0],[0,0,0,2,2,2],[0,0,1,2,2,2],[0,1,0,0,1,4],[0,0,0,0,3,3],[4,0,1,4,3,3]],
        [[4,0,0,0,0,4],[0,0,1,0,0,0],[1,0,0,1,0,0],[4,0,0,2,2,1],[3,3,1,2,2,0],[3,3,4,2,2,0]],
        [[3,3,4,1,0,4],[3,3,0,0,0,0],[4,1,0,0,1,0],[2,2,2,1,0,0],[2,2,2,0,0,0],[0,0,1,0,0,4]],
        [[0,2,2,4,0,0],[0,2,2,1,0,0],[1,2,2,0,0,4],[3,3,1,0,0,1],[3,3,0,1,0,0],[4,0,0,0,0,4]],
        [[4,3,3,1,0,0],[0,3,3,2,2,2],[0,0,1,2,2,2],[0,1,0,0,1,4],[0,0,0,0,0,0],[4,0,1,4,0,0]],
        [[4,0,0,0,0,4],[0,0,1,0,3,3],[1,0,0,1,3,3],[4,0,0,2,2,1],[0,0,1,2,2,0],[0,0,4,2,2,0]],
        [[0,0,4,1,0,4],[0,0,0,0,0,0],[4,1,0,0,1,0],[2,2,2,1,0,0],[2,2,2,3,3,0],[0,0,1,3,3,4]],
        [[0,0,3,3,0,4],[4,1,3,3,1,0],[0,0,0,0,0,0],[1,4,4,1,0,0],[0,0,2,2,2,1],[0,0,2,2,2,0]],
        [[0,0,1,0,4,0],[0,0,4,0,1,0],[2,2,4,0,3,3],[2,2,1,0,3,3],[2,2,0,0,1,0],[0,1,0,0,0,4]],
        [[0,2,2,2,0,0],[1,2,2,2,0,0],[0,0,1,4,4,1],[0,0,0,0,0,0],[0,1,3,3,1,4],[4,0,3,3,0,0]],
        [[4,0,0,0,1,0],[0,1,0,0,2,2],[3,3,0,1,2,2],[3,3,0,4,2,2],[0,1,0,4,0,0],[0,4,0,1,0,0]],
        [[0,0,0,0,0,4],[4,1,0,0,1,0],[0,0,0,0,0,0],[1,4,4,1,0,0],[3,3,2,2,2,1],[3,3,2,2,2,0]],
        [[3,3,1,0,4,0],[3,3,4,0,1,0],[2,2,4,0,0,0],[2,2,1,0,0,0],[2,2,0,0,1,0],[0,1,0,0,0,4]],
        [[0,2,2,2,3,3],[1,2,2,2,3,3],[0,0,1,4,4,1],[0,0,0,0,0,0],[0,1,0,0,1,4],[4,0,0,0,0,0]],
        [[4,0,0,0,1,0],[0,1,0,0,2,2],[0,0,0,1,2,2],[0,0,0,4,2,2],[0,1,0,4,3,3],[0,4,0,1,3,3]],
        [[0,4,3,3,0,0],[0,1,3,3,1,0],[0,0,0,0,4,0],[1,0,0,1,0,0],[4,2,2,2,0,1],[4,2,2,2,0,0]],
        [[4,4,1,0,0,0],[2,2,0,0,1,4],[2,2,0,0,3,3],[2,2,1,0,3,3],[0,0,0,4,1,0],[0,1,0,0,0,0]],
        [[0,0,2,2,2,4],[1,0,2,2,2,4],[0,0,1,0,0,1],[0,4,0,0,0,0],[0,1,3,3,1,0],[0,0,3,3,4,0]],
        [[0,0,0,0,1,0],[0,1,4,0,0,0],[3,3,0,1,2,2],[3,3,0,0,2,2],[4,1,0,0,2,2],[0,0,0,1,4,4]],
        [[0,4,0,0,0,0],[0,1,0,0,1,0],[0,3,3,0,4,0],[1,3,3,1,0,0],[4,2,2,2,0,1],[4,2,2,2,0,0]],
        [[4,4,1,0,0,0],[2,2,3,3,1,4],[2,2,3,3,0,0],[2,2,1,0,0,0],[0,0,0,4,1,0],[0,1,0,0,0,0]],
        [[0,0,2,2,2,4],[1,0,2,2,2,4],[0,0,1,3,3,1],[0,4,0,3,3,0],[0,1,0,0,1,0],[0,0,0,0,4,0]],
        [[0,0,0,0,1,0],[0,1,4,0,0,0],[0,0,0,1,2,2],[0,0,3,3,2,2],[4,1,3,3,2,2],[0,0,0,1,4,4]],
        [[0,0,0,0,4,0],[0,1,0,0,1,0],[0,4,0,0,3,3],[1,0,0,1,3,3],[2,2,2,0,4,1],[2,2,2,4,0,0]],
        [[2,2,1,0,0,0],[2,2,0,4,1,0],[2,2,0,0,0,0],[4,0,1,0,0,0],[0,4,3,3,1,4],[0,1,3,3,0,0]],
        [[0,0,4,2,2,2],[1,4,0,2,2,2],[3,3,1,0,0,1],[3,3,0,0,4,0],[0,1,0,0,1,0],[0,4,0,0,0,0]],
        [[0,0,3,3,1,0],[4,1,3,3,4,0],[0,0,0,1,0,4],[0,0,0,0,2,2],[0,1,4,0,2,2],[0,0,0,1,2,2]],
        [[0,0,0,0,4,0],[0,1,3,3,1,0],[0,4,3,3,0,0],[1,0,0,1,0,0],[2,2,2,0,4,1],[2,2,2,4,0,0]],
        [[2,2,1,0,0,0],[2,2,0,4,1,0],[2,2,0,3,3,0],[4,0,1,3,3,0],[0,4,0,0,1,4],[0,1,0,0,0,0]],
        [[0,0,4,2,2,2],[1,4,0,2,2,2],[0,0,1,0,0,1],[0,0,3,3,4,0],[0,1,3,3,1,0],[0,4,0,0,0,0]],
        [[0,0,0,0,1,0],[4,1,0,0,4,0],[0,3,3,1,0,4],[0,3,3,0,2,2],[0,1,4,0,2,2],[0,0,0,1,2,2]],
        [[4,0,0,0,0,0],[0,1,0,0,1,4],[0,3,3,4,0,0],[1,3,3,1,0,0],[2,2,2,0,0,1],[2,2,2,0,0,4]],
        [[2,2,1,0,0,4],[2,2,3,3,1,0],[2,2,3,3,0,0],[0,0,1,4,0,0],[0,0,0,0,1,0],[4,1,0,0,4,0]],
        [[4,0,0,2,2,2],[1,0,0,2,2,2],[0,0,1,3,3,1],[0,0,4,3,3,0],[4,1,0,0,1,0],[0,0,0,0,0,4]],
        [[0,4,0,0,1,4],[0,1,0,0,0,0],[0,0,4,1,0,0],[0,0,3,3,2,2],[0,1,3,3,2,2],[4,0,0,1,2,2]],
        [[4,0,3,3,0,0],[0,1,3,3,1,4],[0,0,0,4,0,0],[1,0,0,1,0,0],[2,2,2,0,0,1],[2,2,2,0,0,4]],
        [[2,2,1,0,0,4],[2,2,0,0,1,0],[2,2,0,0,3,3],[0,0,1,4,3,3],[0,0,0,0,1,0],[4,1,0,0,4,0]],
        [[4,0,0,2,2,2],[1,0,0,2,2,2],[0,0,1,0,0,1],[0,0,4,0,0,0],[4,1,3,3,1,0],[0,0,3,3,0,4]],
        [[0,4,0,0,1,4],[0,1,0,0,0,0],[3,3,4,1,0,0],[3,3,0,0,2,2],[0,1,0,0,2,2],[4,0,0,1,2,2]],
        [[0,0,0,0,4,0],[0,1,0,0,1,0],[0,4,0,0,3,3],[1,2,2,1,3,3],[0,2,2,0,4,1],[0,2,2,4,0,0]],
        [[0,0,1,0,0,0],[2,2,2,4,1,0],[2,2,2,0,0,0],[4,0,1,0,0,0],[0,4,3,3,1,4],[0,1,3,3,0,0]],
        [[0,0,4,2,2,0],[1,4,0,2,2,0],[3,3,1,2,2,1],[3,3,0,0,4,0],[0,1,0,0,1,0],[0,4,0,0,0,0]],
        [[0,0,3,3,1,0],[4,1,3,3,4,0],[0,0,0,1,0,4],[0,0,0,2,2,2],[0,1,4,2,2,2],[0,0,0,1,0,0]],
        [[0,0,3,3,4,0],[0,1,3,3,1,0],[0,4,0,0,0,0],[1,2,2,1,0,0],[0,2,2,0,4,1],[0,2,2,4,0,0]],
        [[0,0,1,0,0,0],[2,2,2,4,1,0],[2,2,2,0,3,3],[4,0,1,0,3,3],[0,4,0,0,1,4],[0,1,0,0,0,0]],
        [[0,0,4,2,2,0],[1,4,0,2,2,0],[0,0,1,2,2,1],[0,0,0,0,4,0],[0,1,3,3,1,0],[0,4,3,3,0,0]],
        [[0,0,0,0,1,0],[4,1,0,0,4,0],[3,3,0,1,0,4],[3,3,0,2,2,2],[0,1,4,2,2,2],[0,0,0,1,0,0]],
        [[0,4,0,0,0,0],[0,1,3,3,1,0],[0,0,3,3,4,0],[1,2,2,1,0,0],[4,2,2,0,0,1],[4,2,2,0,0,0]],
        [[4,4,1,0,0,0],[2,2,2,0,1,4],[2,2,2,3,3,0],[0,0,1,3,3,0],[0,0,0,4,1,0],[0,1,0,0,0,0]],
        [[0,0,0,2,2,4],[1,0,0,2,2,4],[0,0,1,2,2,1],[0,4,3,3,0,0],[0,1,3,3,1,0],[0,0,0,0,4,0]],
        [[0,0,0,0,1,0],[0,1,4,0,0,0],[0,3,3,1,0,0],[0,3,3,2,2,2],[4,1,0,2,2,2],[0,0,0,1,4,4]],
        [[0,4,0,0,0,0],[0,1,0,0,1,0],[0,0,0,0,4,0],[1,2,2,1,0,0],[4,2,2,3,3,1],[4,2,2,3,3,0]],
        [[4,4,1,0,0,0],[2,2,2,0,1,4],[2,2,2,0,0,0],[3,3,1,0,0,0],[3,3,0,4,1,0],[0,1,0,0,0,0]],
        [[0,3,3,2,2,4],[1,3,3,2,2,4],[0,0,1,2,2,1],[0,4,0,0,0,0],[0,1,0,0,1,0],[0,0,0,0,4,0]],
        [[0,0,0,0,1,0],[0,1,4,0,3,3],[0,0,0,1,3,3],[0,0,0,2,2,2],[4,1,0,2,2,2],[0,0,0,1,4,4]],
        [[4,0,0,0,0,0],[0,1,0,0,1,4],[0,2,2,4,3,3],[1,2,2,1,3,3],[0,2,2,0,0,1],[0,0,0,0,0,4]],
        [[0,0,1,0,0,4],[0,2,2,2,1,0],[0,2,2,2,0,0],[0,0,1,4,0,0],[0,0,3,3,1,0],[4,1,3,3,4,0]],
        [[4,0,0,0,0,0],[1,0,0,2,2,0],[3,3,1,2,2,1],[3,3,4,2,2,0],[4,1,0,0,1,0],[0,0,0,0,0,4]],
        [[0,4,3,3,1,4],[0,1,3,3,0,0],[0,0,4,1,0,0],[0,0,2,2,2,0],[0,1,2,2,2,0],[4,0,0,1,0,0]],
        [[4,0,0,0,0,0],[0,1,0,0,1,4],[0,2,2,4,0,0],[1,2,2,1,0,0],[0,2,2,3,3,1],[0,0,0,3,3,4]],
        [[0,0,1,0,0,4],[0,2,2,2,1,0],[0,2,2,2,0,0],[3,3,1,4,0,0],[3,3,0,0,1,0],[4,1,0,0,4,0]],
        [[4,3,3,0,0,0],[1,3,3,2,2,0],[0,0,1,2,2,1],[0,0,4,2,2,0],[4,1,0,0,1,0],[0,0,0,0,0,4]],
        [[0,4,0,0,1,4],[0,1,0,0,3,3],[0,0,4,1,3,3],[0,0,2,2,2,0],[0,1,2,2,2,0],[4,0,0,1,0,0]],
        [[0,0,2,2,0,4],[4,1,2,2,1,0],[0,0,2,2,3,3],[1,4,4,1,3,3],[0,0,0,0,0,1],[0,0,0,0,0,0]],
        [[0,0,1,0,4,0],[0,0,4,0,1,0],[0,0,4,2,2,2],[0,0,1,2,2,2],[0,0,3,3,1,0],[0,1,3,3,0,4]],
        [[0,0,0,0,0,0],[1,0,0,0,0,0],[3,3,1,4,4,1],[3,3,2,2,0,0],[0,1,2,2,1,4],[4,0,2,2,0,0]],
        [[4,0,3,3,1,0],[0,1,3,3,0,0],[2,2,2,1,0,0],[2,2,2,4,0,0],[0,1,0,4,0,0],[0,4,0,1,0,0]],
        [[0,4,1,0,0,0],[4,0,0,0,1,0],[1,0,3,3,2,2],[0,1,3,3,2,2],[4,0,0,1,2,2],[0,0,0,0,4,0]],
        [[0,4,0,1,4,0],[0,0,1,0,0,4],[0,0,3,3,0,1],[0,1,3,3,0,0],[4,2,2,2,1,0],[0,2,2,2,0,0]],
        [[0,4,0,0,0,0],[2,2,1,0,0,4],[2,2,3,3,1,0],[2,2,3,3,0,1],[0,1,0,0,0,4],[0,0,0,1,4,0]],
        [[0,0,2,2,2,0],[0,1,2,2,2,4],[0,0,3,3,1,0],[1,0,3,3,0,0],[4,0,0,1,0,0],[0,4,1,0,4,0]],
        [[0,4,1,0,0,0],[4,3,3,0,1,0],[1,3,3,0,2,2],[0,1,0,0,2,2],[4,0,0,1,2,2],[0,0,0,0,4,0]],
        [[0,4,0,1,4,0],[0,0,1,3,3,4],[0,0,0,3,3,1],[0,1,0,0,0,0],[4,2,2,2,1,0],[0,2,2,2,0,0]],
        [[0,4,0,0,0,0],[2,2,1,0,0,4],[2,2,0,0,1,0],[2,2,0,3,3,1],[0,1,0,3,3,4],[0,0,0,1,4,0]],
        [[0,0,2,2,2,0],[0,1,2,2,2,4],[0,0,0,0,1,0],[1,3,3,0,0,0],[4,3,3,1,0,0],[0,4,1,0,4,0]],
        [[0,0,1,0,0,4],[0,0,0,0,1,0],[1,0,0,0,0,0],[0,1,4,4,2,2],[0,3,3,1,2,2],[4,3,3,0,2,2]],
        [[4,0,0,1,0,0],[3,3,1,0,0,0],[3,3,4,0,0,1],[0,1,4,0,0,0],[2,2,2,0,1,0],[2,2,2,0,0,4]],
        [[2,2,0,3,3,4],[2,2,1,3,3,0],[2,2,4,4,1,0],[0,0,0,0,0,1],[0,1,0,0,0,0],[4,0,0,1,0,0]],
        [[4,0,0,2,2,2],[0,1,0,2,2,2],[0,0,0,4,1,0],[1,0,0,4,3,3],[0,0,0,1,3,3],[0,0,1,0,0,4]],
        [[3,3,1,0,0,4],[3,3,0,0,1,0],[1,0,0,0,0,0],[0,1,4,4,2,2],[0,0,0,1,2,2],[4,0,0,0,2,2]],
        [[4,0,0,1,3,3],[0,0,1,0,3,3],[0,0,4,0,0,1],[0,1,4,0,0,0],[2,2,2,0,1,0],[2,2,2,0,0,4]],
        [[2,2,0,0,0,4],[2,2,1,0,0,0],[2,2,4,4,1,0],[0,0,0,0,0,1],[0,1,0,0,3,3],[4,0,0,1,3,3]],
        [[4,0,0,2,2,2],[0,1,0,2,2,2],[0,0,0,4,1,0],[1,0,0,4,0,0],[3,3,0,1,0,0],[3,3,1,0,0,4]],
        [[0,0,1,0,0,0],[0,0,0,4,1,4],[1,4,0,2,2,2],[0,1,0,2,2,2],[0,0,0,1,3,3],[0,0,0,4,3,3]],
        [[0,0,0,1,0,0],[0,0,1,4,0,0],[0,0,0,0,0,1],[4,1,2,2,4,0],[3,3,2,2,1,0],[3,3,2,2,4,0]],
        [[3,3,4,0,0,0],[3,3,1,0,0,0],[2,2,2,0,1,0],[2,2,2,0,4,1],[4,1,4,0,0,0],[0,0,0,1,0,0]],
        [[0,4,2,2,3,3],[0,1,2,2,3,3],[0,4,2,2,1,4],[1,0,0,0,0,0],[0,0,4,1,0,0],[0,0,1,0,0,0]],
        [[3,3,1,0,0,0],[3,3,0,4,1,4],[1,4,0,2,2,2],[0,1,0,2,2,2],[0,0,0,1,0,0],[0,0,0,4,0,0]],
        [[0,0,0,1,3,3],[0,0,1,4,3,3],[0,0,0,0,0,1],[4,1,2,2,4,0],[0,0,2,2,1,0],[0,0,2,2,4,0]],
        [[0,0,4,0,0,0],[0,0,1,0,0,0],[2,2,2,0,1,0],[2,2,2,0,4,1],[4,1,4,0,3,3],[0,0,0,1,3,3]],
        [[0,4,2,2,0,0],[0,1,2,2,0,0],[0,4,2,2,1,4],[1,0,0,0,0,0],[3,3,4,1,0,0],[3,3,1,0,0,0]],
        [[0,0,1,0,0,0],[0,0,0,0,1,0],[1,0,2,2,2,4],[4,1,2,2,2,4],[3,3,0,1,0,0],[3,3,4,0,0,0]],
        [[3,3,4,1,0,0],[3,3,1,0,0,0],[4,0,2,2,0,1],[0,1,2,2,0,0],[0,0,2,2,1,0],[0,0,4,4,0,0]],
        [[0,0,0,4,3,3],[0,0,1,0,3,3],[4,2,2,2,1,4],[4,2,2,2,0,1],[0,1,0,0,0,0],[0,0,0,1,0,0]],
        [[0,0,4,4,0,0],[0,1,2,2,0,0],[0,0,2,2,1,0],[1,0,2,2,0,4],[0,0,0,1,3,3],[0,0,1,4,3,3]],
        [[3,3,1,0,0,0],[3,3,0,0,1,0],[1,0,2,2,2,4],[4,1,2,2,2,4],[0,0,0,1,0,0],[0,0,4,0,0,0]],
        [[0,0,4,1,3,3],[0,0,1,0,3,3],[4,0,2,2,0,1],[0,1,2,2,0,0],[0,0,2,2,1,0],[0,0,4,4,0,0]],
        [[0,0,0,4,0,0],[0,0,1,0,0,0],[4,2,2,2,1,4],[4,2,2,2,0,1],[0,1,0,0,3,3],[0,0,0,1,3,3]],
        [[0,0,4,4,0,0],[0,1,2,2,0,0],[0,0,2,2,1,0],[1,0,2,2,0,4],[3,3,0,1,0,0],[3,3,1,4,0,0]],
        [[0,0,1,0,0,0],[0,0,0,4,1,4],[1,4,0,0,3,3],[0,1,0,0,3,3],[2,2,2,1,0,0],[2,2,2,4,0,0]],
        [[2,2,0,1,0,0],[2,2,1,4,0,0],[2,2,0,0,0,1],[4,1,0,0,4,0],[0,0,3,3,1,0],[0,0,3,3,4,0]],
        [[0,0,4,2,2,2],[0,0,1,2,2,2],[3,3,0,0,1,0],[3,3,0,0,4,1],[4,1,4,0,0,0],[0,0,0,1,0,0]],
        [[0,4,3,3,0,0],[0,1,3,3,0,0],[0,4,0,0,1,4],[1,0,0,0,2,2],[0,0,4,1,2,2],[0,0,1,0,2,2]],
        [[0,0,1,0,0,0],[0,0,0,4,1,4],[1,4,0,0,0,0],[0,1,0,0,0,0],[2,2,2,1,3,3],[2,2,2,4,3,3]],
        [[2,2,0,1,0,0],[2,2,1,4,0,0],[2,2,0,0,0,1],[4,1,0,0,4,0],[3,3,0,0,1,0],[3,3,0,0,4,0]],
        [[3,3,4,2,2,2],[3,3,1,2,2,2],[0,0,0,0,1,0],[0,0,0,0,4,1],[4,1,4,0,0,0],[0,0,0,1,0,0]],
        [[0,4,0,0,3,3],[0,1,0,0,3,3],[0,4,0,0,1,4],[1,0,0,0,2,2],[0,0,4,1,2,2],[0,0,1,0,2,2]],
        [[0,0,1,0,0,4],[0,2,2,2,1,0],[1,2,2,2,3,3],[0,1,4,4,3,3],[0,0,0,1,0,0],[4,0,0,0,0,0]],
        [[4,0,0,1,0,0],[0,0,1,2,2,0],[0,0,4,2,2,1],[0,1,4,2,2,0],[0,0,3,3,1,0],[0,0,3,3,0,4]],
        [[0,0,0,0,0,4],[0,0,1,0,0,0],[3,3,4,4,1,0],[3,3,2,2,2,1],[0,1,2,2,2,0],[4,0,0,1,0,0]],
        [[4,0,3,3,0,0],[0,1,3,3,0,0],[0,2,2,4,1,0],[1,2,2,4,0,0],[0,2,2,1,0,0],[0,0,1,0,0,4]],
        [[0,0,1,0,0,4],[0,2,2,2,1,0],[1,2,2,2,0,0],[0,1,4,4,0,0],[0,3,3,1,0,0],[4,3,3,0,0,0]],
        [[4,0,0,1,0,0],[3,3,1,2,2,0],[3,3,4,2,2,1],[0,1,4,2,2,0],[0,0,0,0,1,0],[0,0,0,0,0,4]],
        [[0,0,0,3,3,4],[0,0,1,3,3,0],[0,0,4,4,1,0],[0,0,2,2,2,1],[0,1,2,2,2,0],[4,0,0,1,0,0]],
        [[4,0,0,0,0,0],[0,1,0,0,0,0],[0,2,2,4,1,0],[1,2,2,4,3,3],[0,2,2,1,3,3],[0,0,1,0,0,4]],
        [[0,4,1,0,0,0],[4,0,2,2,1,0],[1,0,2,2,3,3],[0,1,2,2,3,3],[4,0,0,1,0,0],[0,0,0,0,4,0]],
        [[0,4,0,1,4,0],[0,0,1,0,0,4],[0,0,2,2,2,1],[0,1,2,2,2,0],[4,0,3,3,1,0],[0,0,3,3,0,0]],
        [[0,4,0,0,0,0],[0,0,1,0,0,4],[3,3,2,2,1,0],[3,3,2,2,0,1],[0,1,2,2,0,4],[0,0,0,1,4,0]],
        [[0,0,3,3,0,0],[0,1,3,3,0,4],[0,2,2,2,1,0],[1,2,2,2,0,0],[4,0,0,1,0,0],[0,4,1,0,4,0]],
        [[0,4,1,0,0,0],[4,0,2,2,1,0],[1,0,2,2,0,0],[0,1,2,2,0,0],[4,3,3,1,0,0],[0,3,3,0,4,0]],
        [[0,4,0,1,4,0],[3,3,1,0,0,4],[3,3,2,2,2,1],[0,1,2,2,2,0],[4,0,0,0,1,0],[0,0,0,0,0,0]],
        [[0,4,0,3,3,0],[0,0,1,3,3,4],[0,0,2,2,1,0],[0,0,2,2,0,1],[0,1,2,2,0,4],[0,0,0,1,4,0]],
        [[0,0,0,0,0,0],[0,1,0,0,0,4],[0,2,2,2,1,0],[1,2,2,2,3,3],[4,0,0,1,3,3],[0,4,1,0,4,0]],
        [[0,0,1,0,0,0],[0,0,2,2,1,0],[1,0,2,2,0,4],[4,1,2,2,0,4],[0,0,0,1,3,3],[0,0,4,0,3,3]],
        [[0,0,4,1,0,0],[0,0,1,0,0,0],[4,0,2,2,2,1],[0,1,2,2,2,0],[3,3,0,0,1,0],[3,3,4,4,0,0]],
        [[3,3,0,4,0,0],[3,3,1,0,0,0],[4,0,2,2,1,4],[4,0,2,2,0,1],[0,1,2,2,0,0],[0,0,0,1,0,0]],
        [[0,0,4,4,3,3],[0,1,0,0,3,3],[0,2,2,2,1,0],[1,2,2,2,0,4],[0,0,0,1,0,0],[0,0,1,4,0,0]],
        [[0,0,1,0,0,0],[0,0,2,2,1,0],[1,0,2,2,0,4],[4,1,2,2,0,4],[3,3,0,1,0,0],[3,3,4,0,0,0]],
        [[3,3,4,1,0,0],[3,3,1,0,0,0],[4,0,2,2,2,1],[0,1,2,2,2,0],[0,0,0,0,1,0],[0,0,4,4,0,0]],
        [[0,0,0,4,3,3],[0,0,1,0,3,3],[4,0,2,2,1,4],[4,0,2,2,0,1],[0,1,2,2,0,0],[0,0,0,1,0,0]],
        [[0,0,4,4,0,0],[0,1,0,0,0,0],[0,2,2,2,1,0],[1,2,2,2,0,4],[0,0,0,1,3,3],[0,0,1,4,3,3]]
    ];

    constructor() {
        this.board = Array(FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS).fill(null);
        this.clickCount = 0;
        this.score = 0;
        this.selectedCell = null;
        this.obstacleProbabilities = Array(FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS).fill(0);
        this.treasureProbabilities = {
            sword: Array(FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS).fill(0),
            chest: Array(FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS).fill(0),
            fox: Array(FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS).fill(0)
        };
        this.showProbabilities = true;
        this.showTreasureProbabilities = false;
        this.obstaclesConfirmed = false;
        this.showOptimalHighlight = true; // È†êË®≠ÈñãÂïüÈ´ò‰∫ÆÂäüËÉΩ
        this.history = []; // ÂÑ≤Â≠òÊØè‰∏ÄÊ≠•ÁöÑÊ≠∑Âè≤ÁãÄÊÖã
        
        this.elements = {
            board: document.getElementById('game-board'),
            remainingClicks: document.getElementById('remaining-clicks'),
            matchingBoards: document.getElementById('matching-boards'),
            resetBtn: document.getElementById('reset-btn'),
            undoBtn: document.getElementById('undo-btn'),
            autoCalculateBtn: document.getElementById('auto-calculate'),
            toggleProbabilitiesBtn: document.getElementById('toggle-probabilities'),
            resultPanel: document.getElementById('result-panel'),
            finalScore: document.getElementById('final-score'),
            resultDetails: document.getElementById('result-details'),
            popup: document.getElementById('cell-popup'),
            popupBtns: document.querySelectorAll('.popup-btn'),
            popupClose: document.querySelector('.popup-close'),
            gameHint: document.getElementById('game-hint')
        };

        this.initializeBoard();
        this.initializeEvents();
        this.calculateObstacleProbabilities();
        
        // Ë®≠ÂÆöÊåâÈàïÂàùÂßãÊñáÂ≠ó
        this.elements.autoCalculateBtn.textContent = 'ÈóúÈñâÊúÄ‰Ω≥Á≠ñÁï•';
    }

    initializeBoard() {
        this.elements.board.innerHTML = '';
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            const cell = document.createElement('div');
            cell.className = 'board-cell';
            cell.dataset.index = i;
            this.elements.board.appendChild(cell);
        }
    }

    initializeEvents() {
        // Board cell clicks
        this.handleCellClick = (e) => {
            // Find the board-cell element (could be clicked element or its parent)
            let targetCell = e.target;
            while (targetCell && !targetCell.classList.contains('board-cell')) {
                targetCell = targetCell.parentElement;
            }
            
            if (targetCell && targetCell.classList.contains('board-cell')) {
                this.onCellClick(targetCell);
            }
        };
        this.elements.board.addEventListener('click', this.handleCellClick);

        // Popup buttons
        this.elements.popupBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                this.handlePopupSelection(btn.dataset.type);
            });
        });


        // Popup close
        this.elements.popupClose.addEventListener('click', () => {
            this.closePopup();
        });

        // Close popup on overlay click
        this.elements.popup.addEventListener('click', (e) => {
            if (e.target === this.elements.popup) {
                this.closePopup();
            }
        });

        // Reset button
        this.elements.resetBtn.addEventListener('click', () => {
            this.reset();
        });

        // Undo button
        this.elements.undoBtn.addEventListener('click', () => {
            this.undo();
        });

        // Auto calculate button (toggle)
        this.elements.autoCalculateBtn.addEventListener('click', () => {
            this.toggleOptimalHighlight();
        });

        // Toggle probabilities button
        this.elements.toggleProbabilitiesBtn.addEventListener('click', () => {
            this.toggleProbabilities();
        });
    }

    calculateObstacleProbabilities() {
        // ÂàùÂßãË®àÁÆóÔºöÂü∫ÊñºÊâÄÊúâÁõ§Èù¢
        this.updateObstacleProbabilitiesBasedOnMatches();
        this.updateProbabilityDisplay();
        
        // ÂàùÂßãÂåñÊôÇÈ°ØÁ§∫ÊâÄÊúâÁõ§Èù¢ÁöÑÊï∏Èáè
        const matchingCount = this.countMatchingBoards();
        this.elements.matchingBoards.textContent = matchingCount;
    }

    getMatchingBoards() {
        return FauxHollowsFoxes.BOARD_DATA.filter(board => this.boardMatches(board));
    }

    updateObstacleProbabilitiesBasedOnMatches() {
        const obstacleCount = Array(FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS).fill(0);
        const matchingBoards = this.getMatchingBoards();

        // Áµ±Ë®àÁ¨¶ÂêàÁõ§Èù¢‰∏≠ÁöÑÈöúÁ§ôÁâ©‰ΩçÁΩÆ
        for (const board of matchingBoards) {
            for (let row = 0; row < FauxHollowsFoxes.CONSTANTS.BOARD_SIZE; row++) {
                for (let col = 0; col < FauxHollowsFoxes.CONSTANTS.BOARD_SIZE; col++) {
                    const index = row * FauxHollowsFoxes.CONSTANTS.BOARD_SIZE + col;
                    if (board[row][col] === FauxHollowsFoxes.CONSTANTS.CELL_VALUES.OBSTACLE) {
                        obstacleCount[index]++;
                    }
                }
            }
        }

        // Âü∫ÊñºÁ¨¶ÂêàÁöÑÁõ§Èù¢Ë®àÁÆóÊ©üÁéá
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            this.obstacleProbabilities[i] = matchingBoards.length > 0 ? 
                Math.round((obstacleCount[i] / matchingBoards.length) * FauxHollowsFoxes.CONSTANTS.PERCENTAGE) : 0;
        }
    }

    updateTreasureProbabilitiesBasedOnMatches() {
        const treasureCount = {
            sword: Array(FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS).fill(0),
            chest: Array(FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS).fill(0),
            fox: Array(FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS).fill(0)
        };
        const matchingBoards = this.getMatchingBoards();

        // Áµ±Ë®àÁ¨¶ÂêàÁõ§Èù¢‰∏≠ÁöÑÂØ∂Áâ©‰ΩçÁΩÆ
        for (const board of matchingBoards) {
            for (let row = 0; row < FauxHollowsFoxes.CONSTANTS.BOARD_SIZE; row++) {
                for (let col = 0; col < FauxHollowsFoxes.CONSTANTS.BOARD_SIZE; col++) {
                    const index = row * FauxHollowsFoxes.CONSTANTS.BOARD_SIZE + col;
                    const value = board[row][col];
                    if (value === FauxHollowsFoxes.CONSTANTS.CELL_VALUES.SWORD) {
                        treasureCount.sword[index]++;
                    } else if (value === FauxHollowsFoxes.CONSTANTS.CELL_VALUES.CHEST) {
                        treasureCount.chest[index]++;
                    } else if (value === FauxHollowsFoxes.CONSTANTS.CELL_VALUES.FOX_OR_EMPTY) {
                        treasureCount.fox[index]++;
                    }
                }
            }
        }

        // Âü∫ÊñºÁ¨¶ÂêàÁöÑÁõ§Èù¢Ë®àÁÆóÊ©üÁéá
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            this.treasureProbabilities.sword[i] = matchingBoards.length > 0 ? 
                Math.round((treasureCount.sword[i] / matchingBoards.length) * FauxHollowsFoxes.CONSTANTS.PERCENTAGE) : 0;
            this.treasureProbabilities.chest[i] = matchingBoards.length > 0 ? 
                Math.round((treasureCount.chest[i] / matchingBoards.length) * FauxHollowsFoxes.CONSTANTS.PERCENTAGE) : 0;
            this.treasureProbabilities.fox[i] = matchingBoards.length > 0 ? 
                Math.round((treasureCount.fox[i] / matchingBoards.length) * FauxHollowsFoxes.CONSTANTS.PERCENTAGE) : 0;
        }
    }

    updateProbabilityDisplay() {
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            const cell = this.elements.board.children[i];
            
            // ÂÖàÊ∏ÖÈô§ÊâÄÊúâÊ©üÁéáÈ°ØÁ§∫È°ûÂà•
            cell.classList.remove('probability-display', 'treasure-probability-display');
            
            if (this.board[i] === null) {
                // Âè™Âú®Êú™Ë®≠ÁΩÆÁöÑÊ†ºÂ≠ê‰∏äÈ°ØÁ§∫Ê©üÁéá
                cell.textContent = '';
                cell.innerHTML = '';
                
                if (this.showTreasureProbabilities && this.obstaclesConfirmed) {
                    // È°ØÁ§∫ÂØ∂Áâ©Ê©üÁéá
                    this.displayTreasureProbabilities(cell, i);
                } else if (this.showProbabilities) {
                    // È°ØÁ§∫ÈöúÁ§ôÁâ©Ê©üÁéá
                    if (this.obstacleProbabilities[i] > 0) {
                        cell.textContent = `${this.obstacleProbabilities[i]}%`;
                        cell.classList.add('probability-display');
                    }
                }
            } else {
                // Â¶ÇÊûúÊ†ºÂ≠êÂ∑≤Á∂ìË¢´Ë®≠ÁΩÆÔºåÁ¢∫‰øùÈ°ØÁ§∫Ê≠£Á¢∫ÁöÑÂÖßÂÆπ
                this.updateCellDisplay(cell, i);
            }
        }
    }

    displayTreasureProbabilities(cell, index) {
        const swordProb = this.treasureProbabilities.sword[index];
        const chestProb = this.treasureProbabilities.chest[index];
        const foxProb = this.treasureProbabilities.fox[index];
        
        // Êî∂ÈõÜÊúâÊ©üÁéáÁöÑÈ†ÖÁõÆÔºå‰∏¶ÊåâÂÑ™ÂÖàÈ†ÜÂ∫èÊéíÂàóÔºàÂäç„ÄÅÂØ∂ÁÆ±„ÄÅÂÆóÈï∑Ôºâ
        const allProbabilities = [
            { type: 'sword', text: `Âäç${swordProb}%`, prob: swordProb, className: 'sword-prob' },
            { type: 'chest', text: `ÁÆ±${chestProb}%`, prob: chestProb, className: 'chest-prob' },
            { type: 'fox', text: `Áãê${foxProb}%`, prob: foxProb, className: 'fox-prob' }
        ];
        
        // Âè™‰øùÁïôÊúâÊ©üÁéáÁöÑÈ†ÖÁõÆÔºàËá™ÂãïÂæÄ‰∏äÊõøË£úÔºâ
        const validProbabilities = allProbabilities.filter(item => item.prob > 0);
        
        if (validProbabilities.length > 0) {
            // ÂâµÂª∫‰∏âÁ≠â‰ªΩÁµêÊßãÔºåÂè™È°ØÁ§∫ÊúâÊïàÁöÑÊ©üÁéá
            let itemsHtml = '';
            for (let i = 0; i < 3; i++) {
                if (validProbabilities[i]) {
                    itemsHtml += `<div class="treasure-prob-item ${validProbabilities[i].className}">${validProbabilities[i].text}</div>`;
                } else {
                    itemsHtml += `<div class="treasure-prob-item empty-prob"></div>`;
                }
            }
            
            cell.innerHTML = `<div class="treasure-prob-container">${itemsHtml}</div>`;
            cell.classList.add('treasure-probability-display');
        }
    }

    updateCellDisplay(cell, index) {
        const value = this.board[index];
        
        switch (value) {
            case 'obstacle':
                cell.className = 'board-cell obstacle';
                cell.textContent = '‚úï';
                break;
            case 'sword':
                cell.className = 'board-cell sword';
                cell.textContent = '‚öîÔ∏è';
                break;
            case 'chest':
                cell.className = 'board-cell chest';
                cell.textContent = 'üì¶';
                break;
            case 'fox':
                cell.className = 'board-cell fox';
                cell.textContent = 'ü¶ä';
                break;
            case 'empty':
                cell.className = 'board-cell empty';
                cell.textContent = '‚óØ';
                break;
            case 'clicked':
                cell.className = 'board-cell clicked';
                cell.textContent = '';
                break;
            default:
                // ËôïÁêÜÂÖ∂‰ªñÁâπÊÆäÊÉÖÊ≥Å
                if (value && value.startsWith('sword')) {
                    cell.className = 'board-cell sword connected';
                    cell.textContent = '‚öîÔ∏è';
                } else if (value && value.startsWith('chest')) {
                    cell.className = 'board-cell chest connected';
                    cell.textContent = 'üì¶';
                }
                break;
        }
    }

    toggleProbabilities() {
        this.showProbabilities = !this.showProbabilities;
        this.elements.toggleProbabilitiesBtn.textContent = 
            this.showProbabilities ? 'Èö±ËóèÊ©üÁéá' : 'È°ØÁ§∫Ê©üÁéá';
        
        if (this.showProbabilities) {
            this.updateProbabilityDisplay();
        } else {
            // Ê∏ÖÈô§Ê©üÁéáÈ°ØÁ§∫
            for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
                const cell = this.elements.board.children[i];
                if (this.board[i] === null) {
                    cell.textContent = '';
                    cell.classList.remove('probability-display');
                }
            }
        }
    }

    updateMatchingBoards() {
        const matchingCount = this.countMatchingBoards();
        this.elements.matchingBoards.textContent = matchingCount;
        
        // ÈáçÊñ∞Ë®àÁÆóÂü∫ÊñºÁï∂ÂâçÁ¨¶ÂêàÁõ§Èù¢ÁöÑÈöúÁ§ôÁâ©Ê©üÁéá
        this.updateObstacleProbabilitiesBasedOnMatches();
        
        // Â¶ÇÊûúÈöúÁ§ôÁâ©Â∑≤Á¢∫Ë™çÔºå‰πüË®àÁÆóÂØ∂Áâ©Ê©üÁéá
        if (this.obstaclesConfirmed) {
            this.updateTreasureProbabilitiesBasedOnMatches();
        }
        
        this.updateProbabilityDisplay();
        
        // Ê™¢Êü•ÊòØÂê¶ÂèØ‰ª•Ëá™ÂãïÂ°´ÂÖÖÈöúÁ§ôÁâ©
        this.checkAndAutoFillObstacles();
        
        // Êõ¥Êñ∞ÊúÄ‰Ω≥Á≠ñÁï•È´ò‰∫Æ
        this.updateOptimalHighlight();
    }

    countMatchingBoards() {
        return this.getMatchingBoards().length;
    }

    boardMatches(dbBoard) {
        // Ê™¢Êü•‰ΩøÁî®ËÄÖÁï∂ÂâçÁõ§Èù¢ÊòØÂê¶ËàáË≥áÊñôÂ∫´Áõ§Èù¢Áõ∏Á¨¶
        if (!dbBoard || dbBoard.length !== FauxHollowsFoxes.CONSTANTS.BOARD_SIZE) return false;
        
        for (let row = 0; row < FauxHollowsFoxes.CONSTANTS.BOARD_SIZE; row++) {
            if (!dbBoard[row] || dbBoard[row].length !== FauxHollowsFoxes.CONSTANTS.BOARD_SIZE) return false;
            
            for (let col = 0; col < FauxHollowsFoxes.CONSTANTS.BOARD_SIZE; col++) {
                const index = row * FauxHollowsFoxes.CONSTANTS.BOARD_SIZE + col;
                const userValue = this.board[index];
                const dbValue = dbBoard[row][col];
                
                // Âè™ÊúâÁï∂‰ΩøÁî®ËÄÖÂ∑≤Á∂ìË®≠ÁΩÆ‰∫ÜÊüêÂÄã‰ΩçÁΩÆÊôÇÔºåÊâçÊ™¢Êü•ÊòØÂê¶ËàáË≥áÊñôÂ∫´‰∏ÄËá¥
                // null ÂÄºË°®Á§∫Êú™Ë®≠ÁΩÆÔºåÊáâË©≤Ë¢´Ë¶ñÁÇ∫„ÄåÊú™Áü•„ÄçÔºåÂèØ‰ª•ÂåπÈÖç‰ªª‰ΩïË≥áÊñôÂ∫´ÂÄº
                if (userValue !== null) {
                    const userMappedValue = this.mapUserValueToDbValue(userValue);
                    
                    // ÁâπÊÆäËôïÁêÜÔºöË≥áÊñôÂ∫´‰∏≠ÁöÑ FOX_OR_EMPTY Ë°®Á§∫ÂèØËÉΩÊòØÂÆóÈï∑ÊàñÁ©∫Ê†º
                    if (dbValue === FauxHollowsFoxes.CONSTANTS.CELL_VALUES.FOX_OR_EMPTY) {
                        // Â¶ÇÊûúË≥áÊñôÂ∫´ÊòØ FOX_OR_EMPTYÔºå‰ΩøÁî®ËÄÖÂèØ‰ª•ÊòØ fox Êàñ empty
                        if (userMappedValue !== FauxHollowsFoxes.CONSTANTS.CELL_VALUES.FOX_OR_EMPTY && 
                            userMappedValue !== FauxHollowsFoxes.CONSTANTS.CELL_VALUES.EMPTY) {
                            return false;
                        }
                    } else {
                        // ‰∏ÄËà¨ÊÉÖÊ≥ÅÔºöÂøÖÈ†àÂÆåÂÖ®ÂåπÈÖç
                        if (userMappedValue !== dbValue) {
                            return false;
                        }
                    }
                }
                // Â¶ÇÊûú userValue === nullÔºåÂâáË∑≥ÈÅéÊ≠§‰ΩçÁΩÆÁöÑÊ™¢Êü•ÔºàÊú™Áü•ÁãÄÊÖãÂèØÂåπÈÖç‰ªª‰ΩïÂÄºÔºâ
            }
        }
        
        return true;
    }

    mapUserValueToDbValue(userValue) {
        // Â∞á‰ΩøÁî®ËÄÖÁõ§Èù¢ÁöÑÂÄºÊò†Â∞ÑÂà∞Ë≥áÊñôÂ∫´Ê†ºÂºè
        switch (userValue) {
            case 'obstacle': return FauxHollowsFoxes.CONSTANTS.CELL_VALUES.OBSTACLE;
            case 'sword': return FauxHollowsFoxes.CONSTANTS.CELL_VALUES.SWORD;
            case 'chest': return FauxHollowsFoxes.CONSTANTS.CELL_VALUES.CHEST;
            case 'fox': return FauxHollowsFoxes.CONSTANTS.CELL_VALUES.FOX_OR_EMPTY;
            case 'empty': return FauxHollowsFoxes.CONSTANTS.CELL_VALUES.EMPTY;
            default: return FauxHollowsFoxes.CONSTANTS.CELL_VALUES.EMPTY;
        }
    }

    checkAndAutoFillObstacles() {
        // Ë®àÁÆóÂ∑≤Á∂ìÊîæÁΩÆÁöÑÈöúÁ§ôÁâ©Êï∏Èáè
        let obstacleCount = 0;
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            if (this.board[i] === 'obstacle') {
                obstacleCount++;
            }
        }

        // Â¶ÇÊûúÂ∑≤Á∂ìÊúâ2ÂÄãÊàñ‰ª•‰∏äÁöÑÈöúÁ§ôÁâ©ÔºåÊ™¢Êü•ÊòØÂê¶ÂèØ‰ª•Ëá™ÂãïÂ°´ÂÖÖ
        if (obstacleCount >= 2) {
            this.tryAutoFillObstacles();
        }

        // Â¶ÇÊûúÊúâ2ÂÄãÈöúÁ§ôÁâ©‰∫ÜÔºåÈö±ËóèÊèêÁ§∫
        if (obstacleCount >= 2 && this.elements.gameHint) {
            this.elements.gameHint.classList.add('hidden');
        }

        // Ê™¢Êü•ÈöúÁ§ôÁâ©ÊòØÂê¶Â∑≤Á¢∫Ë™çÔºàËá™ÂãïÂ°´ÂÖÖÂÆåÊàêÂæåÔºâ
        this.checkObstaclesConfirmed();
    }

    checkObstaclesConfirmedWithoutAutoFill() {
        // Ëàá checkObstaclesConfirmed Áõ∏ÂêåÁöÑÈÇèËºØÔºå‰ΩÜ‰∏çËß∏ÁôºËá™ÂãïÂ°´ÂÖÖ
        const matchingBoards = [];
        for (const board of FauxHollowsFoxes.BOARD_DATA) {
            if (this.boardMatches(board)) {
                matchingBoards.push(board);
            }
        }

        if (matchingBoards.length === 0) {
            this.obstaclesConfirmed = false;
            return;
        }

        // Ê™¢Êü•ÈöúÁ§ôÁâ©ÊòØÂê¶Â∑≤Á¢∫Ë™ç
        let obstacleCount = 0;
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            if (this.board[i] === 'obstacle') {
                obstacleCount++;
            }
        }
        
        let allObstaclesConfirmed = false;
        if (obstacleCount === 0) {
            allObstaclesConfirmed = false;
        } else {
            // Ê™¢Êü•ÊØèÂÄã‰ΩçÁΩÆÔºöÂ¶ÇÊûúÂú®ÊâÄÊúâÁ¨¶ÂêàÁõ§Èù¢‰∏≠ÈÉΩÊòØÈöúÁ§ôÁâ©ÔºåÂâáÂøÖÈ†àÂ∑≤Ë¢´Ë®≠ÂÆöÁÇ∫ÈöúÁ§ôÁâ©
            allObstaclesConfirmed = true;
            for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
                const row = Math.floor(i / 6);
                const col = i % 6;
                
                // Ê™¢Êü•ÈÄôÂÄã‰ΩçÁΩÆÂú®ÊâÄÊúâÁ¨¶ÂêàÁõ§Èù¢‰∏≠ÊòØÂê¶ÈÉΩÊòØÈöúÁ§ôÁâ©
                let allAreObstacles = true;
                for (const board of matchingBoards) {
                    if (board[row][col] !== 1) {
                        allAreObstacles = false;
                        break;
                    }
                }
                
                // Â¶ÇÊûúÈÄôÂÄã‰ΩçÁΩÆÂú®ÊâÄÊúâÁ¨¶ÂêàÁõ§Èù¢‰∏≠ÈÉΩÊòØÈöúÁ§ôÁâ©Ôºå‰ΩÜ‰ΩøÁî®ËÄÖÈÇÑÊ≤íË®≠ÂÆöÁÇ∫ÈöúÁ§ôÁâ©
                if (allAreObstacles && this.board[i] !== 'obstacle') {
                    allObstaclesConfirmed = false;
                    break;
                }
            }
        }

        const wasConfirmed = this.obstaclesConfirmed;
        this.obstaclesConfirmed = allObstaclesConfirmed;

        // Â¶ÇÊûúÈöúÁ§ôÁâ©ÂâõÁ¢∫Ë™çÔºåÂïüÂãïÂØ∂Áâ©Ê©üÁéáÈ°ØÁ§∫
        if (!wasConfirmed && this.obstaclesConfirmed) {
            this.showTreasureProbabilities = true;
            this.updateTreasureProbabilitiesBasedOnMatches();
            this.updateProbabilityDisplay(); // ÈúÄË¶ÅÊõ¥Êñ∞UIÈ°ØÁ§∫
            FF14Utils.showToast('ÈöúÁ§ôÁâ©‰ΩçÁΩÆÂ∑≤Á¢∫Ë™çÔºÅÁèæÂú®È°ØÁ§∫ÂØ∂Áâ©Ê©üÁéáÔºåÈªûÊìäÊ†ºÂ≠êÂèØÂ°´ÂØ´ÂØ¶ÈöõÁôºÁèæÁöÑÂØ∂Áâ©', 'success');
            
            // Êõ¥Êñ∞ÊúÄ‰Ω≥Á≠ñÁï•È´ò‰∫Æ
            this.updateOptimalHighlight();
        }
    }


    checkIfObstaclesComplete() {
        // Ê™¢Êü•ÊâÄÊúâÊú™Ë®≠ÁΩÆ‰ΩçÁΩÆÁöÑÈöúÁ§ôÁâ©Ê©üÁéáÊòØÂê¶ÈÉΩÂ∑≤Á¢∫ÂÆöÔºà100%Êàñ0%Ôºâ
        let allObstacleProbabilitiesDetermined = true;
        let guaranteedObstacles = [];
        
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            // Ë∑≥ÈÅéÂ∑≤Ë®≠ÁΩÆÁöÑ‰ΩçÁΩÆ
            if (this.board[i] !== null) continue;
            
            const probability = this.obstacleProbabilities[i];
            
            if (probability === FauxHollowsFoxes.CONSTANTS.PERCENTAGE) {
                // 100%Ê©üÁéáÁöÑ‰ΩçÁΩÆÊáâË©≤Ë¢´Ëá™ÂãïÂ°´ÂÖÖÔºåÂ¶ÇÊûúÊ≤íÊúâÂ∞±ÊúâÂïèÈ°å
                guaranteedObstacles.push(i);
            } else if (probability !== 0) {
                // ‰ªãÊñº0-100%‰πãÈñìÔºåÊú™Á¢∫ÂÆö
                allObstacleProbabilitiesDetermined = false;
            }
        }
        
        // Â¶ÇÊûúÊúâ100%Ê©üÁéá‰ΩÜÊú™Â°´ÂÖÖÁöÑ‰ΩçÁΩÆÔºåÂÖàÂ°´ÂÖÖÂÆÉÂÄë
        if (guaranteedObstacles.length > 0) {
            // Ëá™ÂãïÂ°´ÂÖÖÊôÇ‰∏ç‰øùÂ≠òÁãÄÊÖã
            for (const pos of guaranteedObstacles) {
                this.setObstacle(pos, true);
            }
            // ÈáçÊñ∞Ë®àÁÆóÊ©üÁéá‰∏¶ÂÜçÊ¨°Ê™¢Êü•
            this.updateObstacleProbabilitiesBasedOnMatches();
            this.checkIfObstaclesComplete();
            return;
        }
        
        // Âè™ÊúâÁï∂ÊâÄÊúâ‰ΩçÁΩÆÁöÑÈöúÁ§ôÁâ©Ê©üÁéáÈÉΩÂ∑≤Á¢∫ÂÆöÊôÇÔºåÊâçÂàáÊèõÂà∞ÂØ∂Áâ©ÈöéÊÆµ
        if (allObstacleProbabilitiesDetermined && !this.obstaclesConfirmed) {
            this.obstaclesConfirmed = true;
            this.showTreasureProbabilities = true;
            this.updateTreasureProbabilitiesBasedOnMatches();
            FF14Utils.showToast('ÊâÄÊúâÈöúÁ§ôÁâ©‰ΩçÁΩÆÂ∑≤Á¢∫ÂÆöÔºÅÁèæÂú®È°ØÁ§∫ÂØ∂Áâ©Ê©üÁéáÔºåÈªûÊìäÊ†ºÂ≠êÂèØÂ°´ÂØ´ÂØ¶ÈöõÁôºÁèæÁöÑÂØ∂Áâ©', 'success');
            
            // Êõ¥Êñ∞ÊúÄ‰Ω≥Á≠ñÁï•È´ò‰∫Æ
            this.updateOptimalHighlight();
        }
    }

    checkObstaclesConfirmed() {
        // Ê™¢Êü•ÊòØÂê¶ÊâÄÊúâÈöúÁ§ôÁâ©‰ΩçÁΩÆÈÉΩÂ∑≤Á¢∫ÂÆö
        const matchingBoards = [];
        for (const board of FauxHollowsFoxes.BOARD_DATA) {
            if (this.boardMatches(board)) {
                matchingBoards.push(board);
            }
        }

        if (matchingBoards.length === 0) {
            this.obstaclesConfirmed = false;
            return;
        }

        // Ê™¢Êü•ÈöúÁ§ôÁâ©ÊòØÂê¶Â∑≤Á¢∫Ë™ç
        // Ê¢ù‰ª∂ÔºöËá≥Â∞ëÊúâ‰∏Ä‰∫õÈöúÁ§ôÁâ©Â∑≤Ë®≠ÂÆöÔºå‰∏îÊâÄÊúâÁ¨¶ÂêàÁõ§Èù¢‰∏≠ÂøÖÈ†àÁÇ∫ÈöúÁ§ôÁâ©ÁöÑ‰ΩçÁΩÆÈÉΩÂ∑≤Ë®≠ÂÆö
        let obstacleCount = 0;
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            if (this.board[i] === 'obstacle') {
                obstacleCount++;
            }
        }
        
        // Â¶ÇÊûúÊ≤íÊúâ‰ªª‰ΩïÈöúÁ§ôÁâ©ÔºåÂâáÊú™Á¢∫Ë™ç
        let allObstaclesConfirmed;
        if (obstacleCount === 0) {
            allObstaclesConfirmed = false;
        } else {
            // Ê™¢Êü•ÊØèÂÄã‰ΩçÁΩÆÔºöÂ¶ÇÊûúÂú®ÊâÄÊúâÁ¨¶ÂêàÁõ§Èù¢‰∏≠ÈÉΩÊòØÈöúÁ§ôÁâ©ÔºåÂâáÂøÖÈ†àÂ∑≤Ë¢´Ë®≠ÂÆöÁÇ∫ÈöúÁ§ôÁâ©
            allObstaclesConfirmed = true;
            for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
                const row = Math.floor(i / 6);
                const col = i % 6;
                
                // Ê™¢Êü•ÈÄôÂÄã‰ΩçÁΩÆÂú®ÊâÄÊúâÁ¨¶ÂêàÁõ§Èù¢‰∏≠ÊòØÂê¶ÈÉΩÊòØÈöúÁ§ôÁâ©
                let allAreObstacles = true;
                for (const board of matchingBoards) {
                    if (board[row][col] !== 1) {
                        allAreObstacles = false;
                        break;
                    }
                }
                
                // Â¶ÇÊûúÈÄôÂÄã‰ΩçÁΩÆÂú®ÊâÄÊúâÁ¨¶ÂêàÁõ§Èù¢‰∏≠ÈÉΩÊòØÈöúÁ§ôÁâ©Ôºå‰ΩÜ‰ΩøÁî®ËÄÖÈÇÑÊ≤íË®≠ÂÆöÁÇ∫ÈöúÁ§ôÁâ©
                if (allAreObstacles && this.board[i] !== 'obstacle') {
                    allObstaclesConfirmed = false;
                    break;
                }
            }
        }

        const wasConfirmed = this.obstaclesConfirmed;
        this.obstaclesConfirmed = allObstaclesConfirmed;

        // Â¶ÇÊûúÈöúÁ§ôÁâ©ÂâõÁ¢∫Ë™çÔºåÂïüÂãïÂØ∂Áâ©Ê©üÁéáÈ°ØÁ§∫
        if (!wasConfirmed && this.obstaclesConfirmed) {
            this.showTreasureProbabilities = true;
            this.updateTreasureProbabilitiesBasedOnMatches();
            this.updateProbabilityDisplay(); // ÈúÄË¶ÅÊõ¥Êñ∞UIÈ°ØÁ§∫
            FF14Utils.showToast('ÈöúÁ§ôÁâ©‰ΩçÁΩÆÂ∑≤Á¢∫Ë™çÔºÅÁèæÂú®È°ØÁ§∫ÂØ∂Áâ©Ê©üÁéáÔºåÈªûÊìäÊ†ºÂ≠êÂèØÂ°´ÂØ´ÂØ¶ÈöõÁôºÁèæÁöÑÂØ∂Áâ©', 'success');
            
            // Êõ¥Êñ∞ÊúÄ‰Ω≥Á≠ñÁï•È´ò‰∫Æ
            this.updateOptimalHighlight();
        }
    }

    tryAutoFillObstacles() {
        // Êî∂ÈõÜÊâÄÊúâÁ¨¶ÂêàÁöÑÁõ§Èù¢
        const matchingBoards = this.getMatchingBoards();

        // Â¶ÇÊûúÊ≤íÊúâÁ¨¶ÂêàÁöÑÁõ§Èù¢Ôºå‰∏çÂü∑Ë°åËá™ÂãïÂ°´ÂÖÖ
        if (matchingBoards.length === 0) return;

        // Ê™¢Êü•ÊâÄÊúâÁ¨¶ÂêàÁõ§Èù¢‰∏≠ÔºåÊØèÂÄã‰ΩçÁΩÆÁöÑÈöúÁ§ôÁâ©ÊòØÂê¶‰∏ÄËá¥
        const confirmedObstacles = [];
        
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            // Ë∑≥ÈÅéÂ∑≤Á∂ìË®≠ÁΩÆÁöÑÊ†ºÂ≠ê
            if (this.board[i] !== null) continue;

            const row = Math.floor(i / FauxHollowsFoxes.CONSTANTS.BOARD_SIZE);
            const col = i % FauxHollowsFoxes.CONSTANTS.BOARD_SIZE;
            
            // Ê™¢Êü•ÈÄôÂÄã‰ΩçÁΩÆÂú®ÊâÄÊúâÁ¨¶ÂêàÁõ§Èù¢‰∏≠ÊòØÂê¶ÈÉΩÊòØÈöúÁ§ôÁâ©
            let allAreObstacles = true;
            let allAreNotObstacles = true;
            
            for (const board of matchingBoards) {
                if (board[row][col] === FauxHollowsFoxes.CONSTANTS.CELL_VALUES.OBSTACLE) {
                    allAreNotObstacles = false;
                } else {
                    allAreObstacles = false;
                }
            }

            // Â¶ÇÊûúÊâÄÊúâÁ¨¶ÂêàÁöÑÁõ§Èù¢Âú®ÈÄôÂÄã‰ΩçÁΩÆÈÉΩÊòØÈöúÁ§ôÁâ©ÔºåÂâáËá™ÂãïÂ°´ÂÖÖ
            if (allAreObstacles) {
                confirmedObstacles.push(i);
            }
        }

        // Ëá™ÂãïÂ°´ÂÖÖÁ¢∫ÂÆöÁöÑÈöúÁ§ôÁâ©
        if (confirmedObstacles.length > 0) {
            // Ëá™ÂãïÂ°´ÂÖÖÊôÇÔºå‰∏ç‰øùÂ≠òÁãÄÊÖãÔºàÂõ†ÁÇ∫‰ΩøÁî®ËÄÖÁöÑÊâãÂãïÊìç‰ΩúÂ∑≤Á∂ì‰øùÂ≠òÈÅé‰∫ÜÔºâ
            let fillCount = 0;
            for (const index of confirmedObstacles) {
                // ÂÖ®ÈÉ®ÈÉΩË∑≥ÈÅé‰øùÂ≠òÁãÄÊÖã
                this.setObstacle(index, true);
                fillCount++;
            }
            
            // È°ØÁ§∫Ëá™ÂãïÂ°´ÂÖÖÁöÑÊèêÁ§∫
            FF14Utils.showToast(`Â∑≤Ëá™ÂãïÂ°´ÂÖÖ ${fillCount} ÂÄãÁ¢∫ÂÆöÁöÑÈöúÁ§ôÁâ©‰ΩçÁΩÆ`, 'success');
            
            // Êõ¥Êñ∞È°ØÁ§∫Ôºà‰ΩÜ‰∏çËß∏Áôº updateMatchingBoards ÈÅøÂÖçÈÅûËø¥Ôºâ
            this.updateDisplay();
            this.checkForCompletedShapes();
            this.validateShapes();
            
            // ÊâãÂãïÊõ¥Êñ∞Á¨¶ÂêàÁõ§Èù¢Ë®àÊï∏Ôºå‰ΩÜ‰∏çËß∏ÁôºËá™ÂãïÂ°´ÂÖÖ
            const matchingCount = this.countMatchingBoards();
            this.elements.matchingBoards.textContent = matchingCount;
            this.updateObstacleProbabilitiesBasedOnMatches();
            
            // Ê™¢Êü•ÊòØÂê¶ÂÆåÊàêÈöúÁ§ôÁâ©ÈöéÊÆµ
            this.checkIfObstaclesComplete();
            
            this.updateProbabilityDisplay();
        }
    }

    onCellClick(cell) {
        const index = parseInt(cell.dataset.index);
        
        // If cell is already clicked (gray) or occupied, do nothing
        if (cell.classList.contains('clicked') || cell.classList.contains('occupied')) {
            return;
        }

        if (this.obstaclesConfirmed) {
            this.handleTreasurePhaseClick(cell, index);
        } else {
            this.handleObstaclePhaseClick(cell, index);
        }
    }

    handleTreasurePhaseClick(cell, index) {
        // Allow clicking on: null cells, treasure probability display, or existing treasure cells
        const canClick = this.board[index] === null || 
                       cell.classList.contains('treasure-probability-display') ||
                       ['sword', 'chest', 'fox', 'empty'].includes(this.board[index]);
        
        if (canClick) {
            this.selectedCell = index;
            this.showPopup();
        }
    }

    handleObstaclePhaseClick(cell, index) {
        // In obstacle phase, directly place/remove obstacles
        if (this.board[index] === null || cell.classList.contains('treasure-probability-display')) {
            // Place obstacle on empty cell
            this.setObstacle(index);
        } else if (this.board[index] === 'obstacle') {
            // Remove obstacle if clicking on existing obstacle
            this.clearCell(index);
        } else {
            // Cell is occupied by something else, do nothing
            return;
        }
        
        this.updateObstaclePhaseState();
    }

    updateObstaclePhaseState() {
        this.updateDisplay();
        this.checkForCompletedShapes();
        this.validateShapes();
        
        // Êõ¥Êñ∞Á¨¶ÂêàÁõ§Èù¢Ë®àÊï∏‰∏¶Ëß∏ÁôºËá™ÂãïÂ°´ÂÖÖ
        const matchingCount = this.countMatchingBoards();
        this.elements.matchingBoards.textContent = matchingCount;
        this.updateObstacleProbabilitiesBasedOnMatches();
        
        // ÂòóË©¶Ëá™ÂãïÂ°´ÂÖÖÈöúÁ§ôÁâ©‰∏¶Ê™¢Êü•ÊòØÂê¶ÂÆåÊàê
        this.tryAutoFillObstacles();
        
        this.updateProbabilityDisplay();
    }

    showPopup() {
        // Ê†πÊìöÈÅäÊà≤ÈöéÊÆµÈ°ØÁ§∫‰∏çÂêåÁöÑÈÅ∏È†Ö
        this.updatePopupOptions();
        this.elements.popup.style.display = 'flex';
    }

    updatePopupOptions() {
        const popupBtns = this.elements.popup.querySelectorAll('.popup-btn');
        
        if (this.obstaclesConfirmed) {
            // Â°´ÂØ∂Áâ©ÈöéÊÆµÔºöÈ°ØÁ§∫Âäç„ÄÅÂØ∂ÁÆ±„ÄÅÂÆóÈï∑„ÄÅÁ©∫Ê†º„ÄÅÊ∏ÖÈô§
            popupBtns.forEach(btn => {
                const type = btn.dataset.type;
                if (type === 'sword' || type === 'chest' || type === 'fox' || type === 'empty' || type === 'clear') {
                    btn.style.display = 'flex';
                } else {
                    btn.style.display = 'none';
                }
            });
        } else {
            // Â°´ÈöúÁ§ôÁâ©ÈöéÊÆµÔºöÂè™È°ØÁ§∫ÈöúÁ§ôÁâ©„ÄÅÊ∏ÖÈô§
            popupBtns.forEach(btn => {
                const type = btn.dataset.type;
                if (type === 'obstacle' || type === 'clear') {
                    btn.style.display = 'flex';
                } else {
                    btn.style.display = 'none';
                }
            });
        }
    }

    closePopup() {
        this.elements.popup.style.display = 'none';
        this.selectedCell = null;
    }

    handlePopupSelection(type) {
        if (this.selectedCell === null) return;

        const cell = this.elements.board.children[this.selectedCell];

        if (type === 'clear') {
            this.clearCell(this.selectedCell);
        } else if (type === 'obstacle') {
            this.setObstacle(this.selectedCell);
        } else if (type === 'empty') {
            // Check if we can place empty
            if (this.clickCount >= FauxHollowsFoxes.CONSTANTS.MAX_CLICKS) {
                FF14Utils.showToast('Â∑≤ÈÅîÂà∞ÊúÄÂ§ßÈªûÊìäÊ¨°Êï∏ÔºÅ', 'error');
                this.closePopup();
                return;
            }
            this.placeEmpty(this.selectedCell);
        } else {
            // Check if we can place the shape
            if (this.clickCount >= FauxHollowsFoxes.CONSTANTS.MAX_CLICKS) {
                FF14Utils.showToast('Â∑≤ÈÅîÂà∞ÊúÄÂ§ßÈªûÊìäÊ¨°Êï∏ÔºÅ', 'error');
                this.closePopup();
                return;
            }

            // Check shape limits before placing
            if (!this.checkShapeLimits(type)) {
                this.closePopup();
                return;
            }

            // Place single cell
            this.placeSingleCell(this.selectedCell, type);
        }

        this.closePopup();
        this.updateDisplay();
        this.checkForCompletedShapes();
        this.validateShapes();
        this.updateMatchingBoards();
        this.updateOptimalHighlight();
    }

    setObstacle(index, skipSaveState = false) {
        // Âú®‰øÆÊîπÂâçÂÑ≤Â≠òÁãÄÊÖãÔºàÈô§ÈùûÊåáÂÆöË∑≥ÈÅéÔºâ
        if (!skipSaveState) {
            this.saveState();
        }
        
        const cell = this.elements.board.children[index];
        
        // Set as obstacle directly without clearing first
        this.board[index] = 'obstacle';
        cell.className = 'board-cell obstacle';
        cell.textContent = '‚úï';
    }

    clearCell(index) {
        const cell = this.elements.board.children[index];
        
        // Don't allow clearing if it's a gray cell from game completion
        if (this.clickCount >= FauxHollowsFoxes.CONSTANTS.MAX_CLICKS && this.board[index] === null) {
            return;
        }
        
        // Âú®‰øÆÊîπÂâçÂÑ≤Â≠òÁãÄÊÖã
        this.saveState();
        
        // Clear the cell
        this.board[index] = null;
        cell.className = 'board-cell';
        cell.textContent = '';
        
        // Restore probability display if enabled
        if (this.showProbabilities && this.obstacleProbabilities[index] > 0) {
            cell.textContent = `${this.obstacleProbabilities[index]}%`;
            cell.classList.add('probability-display');
        }
        
        // Recalculate everything
        this.recalculateState();
    }

    placeSingleCell(index, type) {
        const cell = this.elements.board.children[index];
        
        // In treasure phase (obstacles confirmed), allow overwriting treasure cells
        if (this.obstaclesConfirmed) {
            // Allow placing on: null cells, treasure probability display, or existing treasure cells
            const canPlace = this.board[index] === null || 
                           cell.classList.contains('treasure-probability-display') ||
                           ['sword', 'chest', 'fox', 'empty'].includes(this.board[index]);
            
            if (!canPlace) {
                FF14Utils.showToast('Ê≠§Ê†ºÂ≠êÁÑ°Ê≥ï‰øÆÊîπÔºÅ', 'error');
                return;
            }
        } else {
            // In obstacle phase, only allow placing on null cells or treasure probability display
            if (this.board[index] !== null && !cell.classList.contains('treasure-probability-display')) {
                FF14Utils.showToast('Ê≠§Ê†ºÂ≠êÂ∑≤Ë¢´‰ΩîÁî®ÔºÅ', 'error');
                return;
            }
        }

        // Âú®‰øÆÊîπÂâçÂÑ≤Â≠òÁãÄÊÖã
        this.saveState();

        // If overwriting an existing treasure cell, don't increment click count
        const isOverwriting = this.obstaclesConfirmed && 
                             ['sword', 'chest', 'fox', 'empty'].includes(this.board[index]);

        // Place the single cell
        this.board[index] = type;
        cell.className = `board-cell ${type}`;
        cell.innerHTML = '';
        
        // Set display text
        if (type === 'fox') {
            cell.textContent = 'Áãê';
        } else if (type === 'sword') {
            cell.textContent = 'Âäç';
        } else if (type === 'chest') {
            cell.textContent = 'ÁÆ±';
        }
        
        // Only increment click count if not overwriting
        if (!isOverwriting) {
            this.clickCount++;
        }
    }

    placeEmpty(index) {
        const cell = this.elements.board.children[index];
        
        // In treasure phase (obstacles confirmed), allow overwriting treasure cells
        if (this.obstaclesConfirmed) {
            // Allow placing on: null cells, treasure probability display, or existing treasure cells
            const canPlace = this.board[index] === null || 
                           cell.classList.contains('treasure-probability-display') ||
                           ['sword', 'chest', 'fox', 'empty'].includes(this.board[index]);
            
            if (!canPlace) {
                FF14Utils.showToast('Ê≠§Ê†ºÂ≠êÁÑ°Ê≥ï‰øÆÊîπÔºÅ', 'error');
                return;
            }
        } else {
            // In obstacle phase, only allow placing on null cells or treasure probability display
            if (this.board[index] !== null && !cell.classList.contains('treasure-probability-display')) {
                FF14Utils.showToast('Ê≠§Ê†ºÂ≠êÂ∑≤Ë¢´‰ΩîÁî®ÔºÅ', 'error');
                return;
            }
        }

        // Âú®‰øÆÊîπÂâçÂÑ≤Â≠òÁãÄÊÖã
        this.saveState();

        // If overwriting an existing treasure cell, don't increment click count
        const isOverwriting = this.obstaclesConfirmed && 
                             ['sword', 'chest', 'fox', 'empty'].includes(this.board[index]);

        this.board[index] = 'empty';
        cell.className = 'board-cell empty';
        cell.innerHTML = '';
        cell.textContent = '';
        
        // Only increment click count if not overwriting
        if (!isOverwriting) {
            this.clickCount++;
        }
    }

    checkShapeLimits(type) {
        // Count existing cells of this type
        let count = 0;
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            if (this.board[i] === type) {
                count++;
            }
        }

        if (type === 'fox' && count >= 1) {
            FF14Utils.showToast('ÂÆóÈï∑Âè™ËÉΩÊîæÁΩÆ 1 Ê†ºÔºÅ', 'error');
            return false;
        } else if (type === 'sword' && count >= 6) {
            FF14Utils.showToast('ÂäçÊúÄÂ§öÂè™ËÉΩÊîæÁΩÆ 6 Ê†ºÔºÅ', 'error');
            return false;
        } else if (type === 'chest' && count >= 4) {
            FF14Utils.showToast('ÂØ∂ÁÆ±ÊúÄÂ§öÂè™ËÉΩÊîæÁΩÆ 4 Ê†ºÔºÅ', 'error');
            return false;
        }

        return true;
    }


    checkForCompletedShapes() {
        // Reset score
        this.score = 0;
        
        // Track processed cells to avoid double counting
        const processed = new Set();
        
        // Check for foxes (1x1)
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            if (this.board[i] === 'fox' && !processed.has(i)) {
                processed.add(i);
                this.score += FauxHollowsFoxes.CONSTANTS.SCORES.FOX;
            }
        }
        
        // Check for chests (2x2)
        for (let row = 0; row < 5; row++) {
            for (let col = 0; col < 5; col++) {
                if (this.checkShapePattern(row, col, 2, 2, 'chest', processed)) {
                    this.score += FauxHollowsFoxes.CONSTANTS.SCORES.CHEST;
                }
            }
        }
        
        // Check for swords (2x3 or 3x2)
        // Check 2x3
        for (let row = 0; row < 4; row++) {
            for (let col = 0; col < 5; col++) {
                if (this.checkShapePattern(row, col, 2, 3, 'sword', processed)) {
                    this.score += FauxHollowsFoxes.CONSTANTS.SCORES.SWORD;
                }
            }
        }
        
        // Check 3x2
        for (let row = 0; row < 5; row++) {
            for (let col = 0; col < 4; col++) {
                if (this.checkShapePattern(row, col, 3, 2, 'sword', processed)) {
                    this.score += FauxHollowsFoxes.CONSTANTS.SCORES.SWORD;
                }
            }
        }
        
        // Only mark surrounding cells as gray when game is complete
        if (this.clickCount >= FauxHollowsFoxes.CONSTANTS.MAX_CLICKS) {
            this.markGrayCells();
        }
        
        this.updateDisplay();
    }

    validateShapes() {
        // Count cells of each type
        const counts = {
            fox: 0,
            sword: 0,
            chest: 0
        };

        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            if (this.board[i] === 'fox') counts.fox++;
            else if (this.board[i] === 'sword') counts.sword++;
            else if (this.board[i] === 'chest') counts.chest++;
        }

        // Check fox limit
        if (counts.fox > 1) {
            FF14Utils.showToast('ÈåØË™§ÔºöÂÆóÈï∑Âè™ËÉΩÊúâ 0 Êàñ 1 Ê†ºÔºÅ', 'error');
            return false;
        }

        // Check sword
        if (counts.sword > 6) {
            FF14Utils.showToast('ÈåØË™§ÔºöÂäçÊúÄÂ§öÂè™ËÉΩÊúâ 6 Ê†ºÔºÅ', 'error');
            return false;
        } else if (counts.sword === 6) {
            // Check if it forms a valid 2x3 or 3x2 shape
            let validShape = false;
            const processed = new Set();
            
            // Check 2x3
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 5; col++) {
                    if (this.checkShapePattern(row, col, 2, 3, 'sword', processed)) {
                        validShape = true;
                        break;
                    }
                }
                if (validShape) break;
            }
            
            // Check 3x2
            if (!validShape) {
                processed.clear();
                for (let row = 0; row < 5; row++) {
                    for (let col = 0; col < 4; col++) {
                        if (this.checkShapePattern(row, col, 3, 2, 'sword', processed)) {
                            validShape = true;
                            break;
                        }
                    }
                    if (validShape) break;
                }
            }

            if (!validShape && processed.size === 6) {
                FF14Utils.showToast('ÈåØË™§Ôºö6 Ê†ºÂäçÂøÖÈ†àÂΩ¢Êàê 2x3 Êàñ 3x2 ÁöÑÂΩ¢ÁãÄÔºÅ', 'error');
                return false;
            }
        }

        // Check chest
        if (counts.chest > 4) {
            FF14Utils.showToast('ÈåØË™§ÔºöÂØ∂ÁÆ±ÊúÄÂ§öÂè™ËÉΩÊúâ 4 Ê†ºÔºÅ', 'error');
            return false;
        } else if (counts.chest === 4) {
            // Check if it forms a valid 2x2 shape
            let validShape = false;
            const processed = new Set();
            
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    if (this.checkShapePattern(row, col, 2, 2, 'chest', processed)) {
                        validShape = true;
                        break;
                    }
                }
                if (validShape) break;
            }

            if (!validShape) {
                FF14Utils.showToast('ÈåØË™§Ôºö4 Ê†ºÂØ∂ÁÆ±ÂøÖÈ†àÂΩ¢Êàê 2x2 ÁöÑÂΩ¢ÁãÄÔºÅ', 'error');
                return false;
            }
        }

        return true;
    }
    
    checkShapePattern(row, col, width, height, type, processed) {
        // Check if all cells in the pattern match the type
        const cells = [];
        
        for (let r = row; r < row + height; r++) {
            for (let c = col; c < col + width; c++) {
                const index = r * 6 + c;
                if (this.board[index] !== type || processed.has(index)) {
                    return false;
                }
                cells.push(index);
            }
        }
        
        // Mark all cells as processed
        cells.forEach(index => processed.add(index));
        return true;
    }

    
    markGrayCells() {
        // Mark all remaining empty cells as gray when game is complete
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            if (this.board[i] === null) {
                const cell = this.elements.board.children[i];
                cell.className = 'board-cell clicked';
            }
        }
    }


    recalculateState() {
        // Reset click count
        this.clickCount = 0;

        // Count all non-obstacle, non-null cells
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            const value = this.board[i];
            if (value && value !== 'obstacle') {
                this.clickCount++;
            }
        }

        // Recalculate shapes and score
        this.checkForCompletedShapes();
        this.validateShapes();
        this.updateMatchingBoards();
    }

    updateDisplay() {
        this.elements.remainingClicks.textContent = FauxHollowsFoxes.CONSTANTS.MAX_CLICKS - this.clickCount;

        // Check if game is complete
        if (this.clickCount >= FauxHollowsFoxes.CONSTANTS.MAX_CLICKS) {
            this.showResult();
        }
    }

    showResult() {
        this.elements.finalScore.textContent = this.score;
        
        // Calculate shape counts
        const shapes = { sword: 0, chest: 0, fox: 0 };
        const counted = new Set();
        
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            const value = this.board[i];
            if (value && !counted.has(value) && value !== 'obstacle' && value !== 'clicked') {
                counted.add(value);
                if (value === 'fox') shapes.fox++;
                else if (value.startsWith('sword')) shapes.sword++;
                else if (value.startsWith('chest')) shapes.chest++;
            }
        }

        this.elements.resultDetails.innerHTML = `
            <p>Âäç x ${shapes.sword} = ${shapes.sword * FauxHollowsFoxes.CONSTANTS.SCORES.SWORD} ÂàÜ</p>
            <p>ÂØ∂ÁÆ± x ${shapes.chest} = ${shapes.chest * FauxHollowsFoxes.CONSTANTS.SCORES.CHEST} ÂàÜ</p>
            <p>ÂÆóÈï∑ x ${shapes.fox} = ${shapes.fox * FauxHollowsFoxes.CONSTANTS.SCORES.FOX} ÂàÜ</p>
        `;

        this.elements.resultPanel.style.display = 'block';
    }


    toggleOptimalHighlight() {
        this.showOptimalHighlight = !this.showOptimalHighlight;
        
        if (this.showOptimalHighlight) {
            this.elements.autoCalculateBtn.textContent = 'ÈóúÈñâÊúÄ‰Ω≥Á≠ñÁï•';
            this.updateOptimalHighlight();
        } else {
            this.elements.autoCalculateBtn.textContent = 'È°ØÁ§∫ÊúÄ‰Ω≥Á≠ñÁï•';
            this.clearHighlights();
        }
    }
    
    updateOptimalHighlight() {
        // Ê∏ÖÈô§‰πãÂâçÁöÑÈ´ò‰∫Æ
        this.clearHighlights();
        
        // Â¶ÇÊûúÂäüËÉΩÈóúÈñâÊàñÈöúÁ§ôÁâ©Êú™Á¢∫Ë™çÔºå‰∏çÈÄ≤Ë°åÈ´ò‰∫Æ
        if (!this.showOptimalHighlight || !this.obstaclesConfirmed) {
            return;
        }
        
        // Á¢∫‰øùÂØ∂Áâ©Ê©üÁéáÂ∑≤Êõ¥Êñ∞
        this.updateTreasureProbabilitiesBasedOnMatches();
        
        // ÊâæÂá∫ÊúÄÈ´òÊ©üÁéáÁöÑÂäçÂíåÂØ∂ÁÆ±‰ΩçÁΩÆ
        const optimalCells = this.findOptimalCells();
        
        if (optimalCells.length > 0) {
            // È´ò‰∫ÆÈÄô‰∫õÊ†ºÂ≠ê
            optimalCells.forEach(cellData => {
                const cell = this.elements.board.children[cellData.index];
                cell.classList.add('optimal-highlight');
                cell.dataset.optimalType = cellData.type;
                cell.dataset.optimalProbability = cellData.probability;
            });
        }
    }
    
    findOptimalCells() {
        const optimalCells = [];
        let maxSwordProb = 0;
        let maxChestProb = 0;
        
        // ÂÖàÊâæÂá∫ÊúÄÈ´òÊ©üÁéá
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            // Ë∑≥ÈÅéÂ∑≤Á∂ìÊúâÂÖßÂÆπÁöÑÊ†ºÂ≠ê
            if (this.board[i] !== null) continue;
            
            const swordProb = this.treasureProbabilities.sword[i];
            const chestProb = this.treasureProbabilities.chest[i];
            
            if (swordProb > maxSwordProb) {
                maxSwordProb = swordProb;
            }
            
            if (chestProb > maxChestProb) {
                maxChestProb = chestProb;
            }
        }
        
        // ÊâæÂá∫ÊâÄÊúâÁ≠âÊñºÊúÄÈ´òÊ©üÁéáÁöÑÊ†ºÂ≠ê
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            // Ë∑≥ÈÅéÂ∑≤Á∂ìÊúâÂÖßÂÆπÁöÑÊ†ºÂ≠ê
            if (this.board[i] !== null) continue;
            
            const swordProb = this.treasureProbabilities.sword[i];
            const chestProb = this.treasureProbabilities.chest[i];
            
            // Âä†ÂÖ•ÊâÄÊúâÊúÄÈ´òÊ©üÁéáÁöÑÂäç‰ΩçÁΩÆ
            if (swordProb > 0 && swordProb === maxSwordProb) {
                optimalCells.push({
                    index: i,
                    type: 'sword',
                    probability: swordProb
                });
            }
            
            // Âä†ÂÖ•ÊâÄÊúâÊúÄÈ´òÊ©üÁéáÁöÑÂØ∂ÁÆ±‰ΩçÁΩÆ
            if (chestProb > 0 && chestProb === maxChestProb) {
                optimalCells.push({
                    index: i,
                    type: 'chest',
                    probability: chestProb
                });
            }
        }
        
        return optimalCells;
    }
    
    clearHighlights() {
        // Ê∏ÖÈô§ÊâÄÊúâÈ´ò‰∫ÆÊïàÊûú
        const cells = this.elements.board.querySelectorAll('.optimal-highlight');
        cells.forEach(cell => {
            cell.classList.remove('optimal-highlight');
            delete cell.dataset.optimalType;
            delete cell.dataset.optimalProbability;
        });
    }

    saveState() {
        // ÂÑ≤Â≠òÁõÆÂâçÁãÄÊÖãÂà∞Ê≠∑Âè≤Ë®òÈåÑ
        const state = {
            board: [...this.board],
            clickCount: this.clickCount,
            score: this.score,
            obstaclesConfirmed: this.obstaclesConfirmed,
            showTreasureProbabilities: this.showTreasureProbabilities,
            obstacleProbabilities: [...this.obstacleProbabilities],
            treasureProbabilities: {
                sword: [...this.treasureProbabilities.sword],
                chest: [...this.treasureProbabilities.chest],
                fox: [...this.treasureProbabilities.fox]
            }
        };
        this.history.push(state);
        
        // ÈôêÂà∂Ê≠∑Âè≤Ë®òÈåÑÈï∑Â∫¶ÔºåÈÅøÂÖçÂç†Áî®Â§™Â§öË®òÊÜ∂È´î
        if (this.history.length > 50) {
            this.history.shift();
        }
        
        // ÂïüÁî®ÂõûÂà∞‰∏ä‰∏ÄÊ≠•ÊåâÈàï
        this.elements.undoBtn.disabled = false;
    }

    undo() {
        if (this.history.length === 0) return;
        
        // ÂèñÂá∫‰∏ä‰∏ÄÊ≠•ÁöÑÁãÄÊÖã
        const previousState = this.history.pop();
        
        // ÊÅ¢Âæ©ÁãÄÊÖã
        this.board = [...previousState.board];
        this.clickCount = previousState.clickCount;
        this.score = previousState.score;
        this.obstaclesConfirmed = previousState.obstaclesConfirmed;
        this.showTreasureProbabilities = previousState.showTreasureProbabilities;
        this.obstacleProbabilities = [...previousState.obstacleProbabilities];
        this.treasureProbabilities = {
            sword: [...previousState.treasureProbabilities.sword],
            chest: [...previousState.treasureProbabilities.chest],
            fox: [...previousState.treasureProbabilities.fox]
        };
        
        // ÈáçÊñ∞Ê∏≤ÊüìÁõ§Èù¢
        this.renderBoard();
        
        // Êõ¥Êñ∞È°ØÁ§∫
        this.updateDisplay();
        this.updateMatchingBoards();
        this.updateProbabilityDisplay();
        this.updateOptimalHighlight();
        
        // Â¶ÇÊûúÊ≤íÊúâÊ≠∑Âè≤Ë®òÈåÑ‰∫ÜÔºåÁ¶ÅÁî®ÂõûÂà∞‰∏ä‰∏ÄÊ≠•ÊåâÈàï
        if (this.history.length === 0) {
            this.elements.undoBtn.disabled = true;
        }
        
        // Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÈ°ØÁ§∫ÊèêÁ§∫
        if (!this.obstaclesConfirmed && this.elements.gameHint) {
            let obstacleCount = 0;
            for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
                if (this.board[i] === 'obstacle') {
                    obstacleCount++;
                }
            }
            if (obstacleCount < 2) {
                this.elements.gameHint.classList.remove('hidden');
            }
        }
    }

    renderBoard() {
        // ÈáçÊñ∞Ê∏≤ÊüìÊï¥ÂÄãÁõ§Èù¢
        for (let i = 0; i < FauxHollowsFoxes.CONSTANTS.TOTAL_CELLS; i++) {
            const cell = this.elements.board.children[i];
            const value = this.board[i];
            
            // Ê∏ÖÁ©∫ÂÖßÂÆπ
            cell.className = 'board-cell';
            cell.textContent = '';
            
            if (value === null) {
                // Á©∫Ê†ºÂ≠ê
                if (this.showProbabilities) {
                    if (!this.obstaclesConfirmed && this.obstacleProbabilities[i] > 0) {
                        cell.textContent = `${this.obstacleProbabilities[i]}%`;
                        cell.classList.add('probability-display');
                    } else if (this.obstaclesConfirmed && this.showTreasureProbabilities) {
                        const swordProb = this.treasureProbabilities.sword[i];
                        const chestProb = this.treasureProbabilities.chest[i];
                        const foxProb = this.treasureProbabilities.fox[i];
                        
                        if (swordProb > 0 || chestProb > 0 || foxProb > 0) {
                            cell.innerHTML = `
                                <div class="treasure-prob-container">
                                    ${swordProb > 0 ? `<div class="treasure-prob sword-prob">Âäç:${swordProb}%</div>` : ''}
                                    ${chestProb > 0 ? `<div class="treasure-prob chest-prob">ÁÆ±:${chestProb}%</div>` : ''}
                                    ${foxProb > 0 ? `<div class="treasure-prob fox-prob">Áãê:${foxProb}%</div>` : ''}
                                </div>
                            `;
                            cell.classList.add('treasure-probability-display');
                        }
                    }
                }
            } else if (value === 'obstacle') {
                cell.className = 'board-cell obstacle';
                cell.textContent = '‚úï';
            } else if (value === 'sword') {
                cell.className = 'board-cell sword';
                cell.textContent = 'Âäç';
            } else if (value === 'chest') {
                cell.className = 'board-cell chest';
                cell.textContent = 'ÁÆ±';
            } else if (value === 'fox') {
                cell.className = 'board-cell fox';
                cell.textContent = 'Áãê';
            } else if (value === 'empty') {
                cell.className = 'board-cell empty';
            } else if (value === 'clicked') {
                cell.className = 'board-cell clicked';
            }
        }
    }

    reset() {
        // Clear board
        this.board = Array(36).fill(null);
        this.clickCount = 0;
        this.score = 0;
        this.selectedCell = null;
        this.obstacleProbabilities = Array(36).fill(0);
        this.treasureProbabilities = {
            sword: Array(36).fill(0),
            chest: Array(36).fill(0),
            fox: Array(36).fill(0)
        };
        this.obstaclesConfirmed = false;
        this.showTreasureProbabilities = false;
        this.showOptimalHighlight = true; // ÈáçÁΩÆÊôÇÂõûÂæ©È†êË®≠ÈñãÂïü
        this.history = []; // Ê∏ÖÁ©∫Ê≠∑Âè≤Ë®òÈåÑ
        
        // Ê∏ÖÈô§È´ò‰∫Æ
        this.clearHighlights();
        
        // Êõ¥Êñ∞ÊåâÈàïÊñáÂ≠ó
        this.elements.autoCalculateBtn.textContent = 'ÈóúÈñâÊúÄ‰Ω≥Á≠ñÁï•';
        
        // Á¶ÅÁî®ÂõûÂà∞‰∏ä‰∏ÄÊ≠•ÊåâÈàï
        this.elements.undoBtn.disabled = true;
        
        // Reset UI
        this.initializeBoard();
        this.updateDisplay();
        this.elements.resultPanel.style.display = 'none';
        
        // Restore probability display if enabled
        this.updateProbabilityDisplay();
        this.updateMatchingBoards();
        
        // È°ØÁ§∫ÊèêÁ§∫
        if (this.elements.gameHint) {
            this.elements.gameHint.classList.remove('hidden');
        }
    }
}

// Initialize the game when page loads
let game;
document.addEventListener('DOMContentLoaded', () => {
    game = new FauxHollowsFoxes();
});
