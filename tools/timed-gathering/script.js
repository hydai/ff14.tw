// ÁâπÊÆäÊé°ÈõÜÊôÇÈñìÁÆ°ÁêÜÂô®‰∏ªÊéßÂà∂Âô®
class TimedGatheringManager {
    static CONSTANTS = {
        DEBOUNCE_DELAY: 300,
        STORAGE_KEY_PREFIX: 'ff14tw_timed_gathering_',
        DEFAULT_LIST_NAME: 'È†êË®≠Ê∏ÖÂñÆ',
        MAX_LIST_NAME_LENGTH: 50,
        MAX_LISTS: 10
    };

    constructor() {
        this.data = [];
        this.filteredData = [];
        this.listManager = null;
        this.macroExporter = null;
        this.searchFilter = null;
        this.currentListId = 'default';
        this.debounceTimer = null;
        
        this.elements = {
            // ÊêúÂ∞ãËàáÁØ©ÈÅ∏
            searchInput: document.getElementById('searchInput'),
            clearSearchBtn: document.getElementById('clearSearchBtn'),
            typeFilters: document.getElementById('typeFilters'),
            expansionFilters: document.getElementById('expansionFilters'),
            
            // È†ÖÁõÆÈ°ØÁ§∫
            itemsContainer: document.getElementById('itemsContainer'),
            itemCount: document.getElementById('itemCount'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            errorMessage: document.getElementById('errorMessage'),
            
            // Ê∏ÖÂñÆÁÆ°ÁêÜ
            listTabs: document.getElementById('listTabs'),
            currentListName: document.getElementById('currentListName'),
            listItems: document.getElementById('listItems'),
            newListBtn: document.getElementById('newListBtn'),
            renameListBtn: document.getElementById('renameListBtn'),
            deleteListBtn: document.getElementById('deleteListBtn'),
            clearListBtn: document.getElementById('clearListBtn'),
            
            // ÂåØÂÖ•/ÂåØÂá∫
            importBtn: document.getElementById('importBtn'),
            exportBtn: document.getElementById('exportBtn'),
            
            // Â∑®ÈõÜ
            generateMacroBtn: document.getElementById('generateMacroBtn'),
            includeClearCmd: document.getElementById('includeClearCmd'),
            sortByTime: document.getElementById('sortByTime'),
            macroOutput: document.getElementById('macroOutput'),
            macroText: document.getElementById('macroText'),
            copyMacroBtn: document.getElementById('copyMacroBtn'),
            
            // Â∞çË©±Ê°Ü
            dialogOverlay: document.getElementById('dialogOverlay'),
            dialogTitle: document.getElementById('dialogTitle'),
            dialogBody: document.getElementById('dialogBody'),
            dialogClose: document.getElementById('dialogClose'),
            dialogCancel: document.getElementById('dialogCancel'),
            dialogConfirm: document.getElementById('dialogConfirm')
        };
        
        this.initialize();
    }

    async initialize() {
        try {
            // ÂàùÂßãÂåñÊ®°ÁµÑ
            this.listManager = new ListManager();
            this.macroExporter = new MacroExporter();
            this.searchFilter = new SearchFilter();
            
            // ËºâÂÖ•Ë≥áÊñô
            await this.loadData();
            
            // ÂàùÂßãÂåñ‰∫ã‰ª∂
            this.initializeEvents();
            
            // ËºâÂÖ•Ê∏ÖÂñÆ
            this.loadLists();
            
            // ÂàùÂßãÈ°ØÁ§∫
            this.updateDisplay();
            
        } catch (error) {
            console.error('ÂàùÂßãÂåñÂ§±Êïó:', error);
            this.showError('ÂàùÂßãÂåñÂ§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢');
        }
    }

    async loadData() {
        this.showLoading(true);
        try {
            const response = await fetch('../../data/timed-gathering.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const jsonData = await response.json();
            this.data = jsonData.items || [];
            this.filteredData = [...this.data];
            
            // Êõ¥Êñ∞È†ÖÁõÆË®àÊï∏
            this.updateItemCount();
            
        } catch (error) {
            console.error('ËºâÂÖ•Ë≥áÊñôÂ§±Êïó:', error);
            this.showError('ËºâÂÖ•Êé°ÈõÜÁâ©Ë≥áÊñôÂ§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢ÂÜçË©¶');
        } finally {
            this.showLoading(false);
        }
    }

    initializeEvents() {
        // ÊêúÂ∞ã
        this.elements.searchInput.addEventListener('input', () => {
            this.debounceSearch();
        });
        
        this.elements.clearSearchBtn.addEventListener('click', () => {
            this.elements.searchInput.value = '';
            this.applyFilters();
        });
        
        // È°ûÂûãÁØ©ÈÅ∏
        this.elements.typeFilters.querySelectorAll('.tag-filter').forEach(tag => {
            tag.addEventListener('click', () => {
                tag.classList.toggle('active');
                this.applyFilters();
            });
        });
        
        // Ë≥áÊñôÁâáÁØ©ÈÅ∏
        this.elements.expansionFilters.querySelectorAll('.tag-filter').forEach(tag => {
            tag.addEventListener('click', () => {
                tag.classList.toggle('active');
                this.applyFilters();
            });
        });
        
        // Ê∏ÖÂñÆÁÆ°ÁêÜ
        this.elements.newListBtn.addEventListener('click', () => {
            this.showNewListDialog();
        });
        
        this.elements.renameListBtn.addEventListener('click', () => {
            this.showRenameListDialog();
        });
        
        this.elements.deleteListBtn.addEventListener('click', () => {
            this.showDeleteListDialog();
        });
        
        this.elements.clearListBtn.addEventListener('click', () => {
            this.clearCurrentList();
        });
        
        // ÂåØÂÖ•/ÂåØÂá∫
        this.elements.importBtn.addEventListener('click', () => {
            this.showImportDialog();
        });
        
        this.elements.exportBtn.addEventListener('click', () => {
            this.exportLists();
        });
        
        // Â∑®ÈõÜ
        this.elements.generateMacroBtn.addEventListener('click', () => {
            this.generateMacro();
        });
        
        this.elements.copyMacroBtn.addEventListener('click', () => {
            this.copyMacroToClipboard();
        });
        
        // Â∞çË©±Ê°Ü
        this.elements.dialogClose.addEventListener('click', () => {
            this.hideDialog();
        });
        
        this.elements.dialogCancel.addEventListener('click', () => {
            this.hideDialog();
        });
        
        // ESC ÈóúÈñâÂ∞çË©±Ê°Ü
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.elements.dialogOverlay.style.display !== 'none') {
                this.hideDialog();
            }
        });
    }

    debounceSearch() {
        clearTimeout(this.debounceTimer);
        this.debounceTimer = setTimeout(() => {
            this.applyFilters();
        }, TimedGatheringManager.CONSTANTS.DEBOUNCE_DELAY);
    }

    applyFilters() {
        const searchTerm = this.elements.searchInput.value.toLowerCase();
        const activeTypes = Array.from(this.elements.typeFilters.querySelectorAll('.tag-filter.active'))
            .map(tag => tag.dataset.type);
        const activeExpansions = Array.from(this.elements.expansionFilters.querySelectorAll('.tag-filter.active'))
            .map(tag => tag.dataset.expansion);
        
        this.filteredData = this.searchFilter.filter(this.data, {
            searchTerm,
            types: activeTypes,
            expansions: activeExpansions
        });
        
        this.updateDisplay();
    }

    updateDisplay() {
        this.renderItems();
        this.updateItemCount();
    }

    renderItems() {
        const container = this.elements.itemsContainer;
        container.innerHTML = '';
        
        if (this.filteredData.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'empty-message';
            emptyMessage.textContent = 'Ê≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑÊé°ÈõÜÁâ©';
            container.appendChild(emptyMessage);
            return;
        }
        
        this.filteredData.forEach(item => {
            const card = this.createItemCard(item);
            container.appendChild(card);
        });
    }

    createItemCard(item) {
        const card = document.createElement('div');
        card.className = 'item-card';
        card.dataset.itemId = item.id;
        
        const typeIcon = this.getTypeIcon(item.type);
        const isInList = this.listManager.hasInCurrentList(this.currentListId, item.id);
        
        const header = document.createElement('div');
        header.className = 'item-header';
        
        const titleSection = document.createElement('div');
        titleSection.className = 'item-title-section';
        
        const typeSpan = document.createElement('span');
        typeSpan.className = 'item-type';
        typeSpan.textContent = typeIcon;
        titleSection.appendChild(typeSpan);
        
        const title = document.createElement('h3');
        title.className = 'item-name';
        title.textContent = item.name;
        titleSection.appendChild(title);
        
        header.appendChild(titleSection);
        
        const timeSpan = document.createElement('span');
        timeSpan.className = 'item-time';
        timeSpan.textContent = item.time;
        header.appendChild(timeSpan);
        
        card.appendChild(header);
        
        const body = document.createElement('div');
        body.className = 'item-body';
        
        const info = document.createElement('div');
        info.className = 'item-info';
        
        const zoneDiv = document.createElement('div');
        zoneDiv.className = 'item-zone';
        zoneDiv.textContent = `üìç ${item.zone} - ${item.location}`;
        info.appendChild(zoneDiv);
        
        const coordsDiv = document.createElement('div');
        coordsDiv.className = 'item-coords';
        coordsDiv.textContent = `üìê ${item.coordinates}`;
        info.appendChild(coordsDiv);
        
        const levelDiv = document.createElement('div');
        levelDiv.className = 'item-level';
        levelDiv.textContent = `Lv.${item.level}`;
        info.appendChild(levelDiv);
        
        body.appendChild(info);
        
        if (item.description) {
            const desc = document.createElement('p');
            desc.className = 'item-description';
            desc.textContent = item.description;
            body.appendChild(desc);
        }
        
        card.appendChild(body);
        
        const footer = document.createElement('div');
        footer.className = 'item-footer';
        
        const addBtn = document.createElement('button');
        addBtn.className = isInList ? 'btn btn-success btn-sm' : 'btn btn-primary btn-sm';
        addBtn.innerHTML = isInList ? 
            '<span class="btn-icon">‚úîÔ∏è</span> Â∑≤Âä†ÂÖ•' : 
            '<span class="btn-icon">‚ûï</span> Âä†ÂÖ•Ê∏ÖÂñÆ';
        addBtn.disabled = isInList;
        
        addBtn.addEventListener('click', () => {
            this.addItemToList(item);
            addBtn.className = 'btn btn-success btn-sm';
            addBtn.innerHTML = '<span class="btn-icon">‚úîÔ∏è</span> Â∑≤Âä†ÂÖ•';
            addBtn.disabled = true;
        });
        
        footer.appendChild(addBtn);
        card.appendChild(footer);
        
        return card;
    }

    getTypeIcon(type) {
        const icons = {
            'mining': '‚õèÔ∏è',
            'botany': 'üåø',
            'fishing': 'üé£'
        };
        return icons[type] || '‚ùì';
    }

    addItemToList(item) {
        const result = this.listManager.addToList(this.currentListId, item);
        if (result.success) {
            this.updateListDisplay();
            this.showNotification('Â∑≤Âä†ÂÖ•Ê∏ÖÂñÆ', 'success');
        } else {
            this.showNotification(result.message, 'warning');
        }
    }

    updateListDisplay() {
        const list = this.listManager.getList(this.currentListId);
        const container = this.elements.listItems;
        container.innerHTML = '';
        
        if (!list || list.items.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'empty-list-message';
            emptyMessage.innerHTML = `
                <p>Ê∏ÖÂñÆÁÇ∫Á©∫</p>
                <small>ÂæûÂ∑¶ÂÅ¥ÈªûÊìä„ÄåÂä†ÂÖ•Ê∏ÖÂñÆ„ÄçÊåâÈàï‰æÜÊñ∞Â¢ûÊé°ÈõÜÁâ©</small>
            `;
            container.appendChild(emptyMessage);
            return;
        }
        
        list.items.forEach(item => {
            const listItem = this.createListItem(item);
            container.appendChild(listItem);
        });
    }

    createListItem(item) {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.dataset.itemId = item.id;
        
        const info = document.createElement('div');
        info.className = 'list-item-info';
        
        const typeIcon = document.createElement('span');
        typeIcon.className = 'list-item-type';
        typeIcon.textContent = this.getTypeIcon(item.type);
        info.appendChild(typeIcon);
        
        const name = document.createElement('span');
        name.className = 'list-item-name';
        name.textContent = item.name;
        info.appendChild(name);
        
        const time = document.createElement('span');
        time.className = 'list-item-time';
        time.textContent = item.time;
        info.appendChild(time);
        
        div.appendChild(info);
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn btn-sm btn-danger';
        removeBtn.innerHTML = 'üóëÔ∏è';
        removeBtn.title = 'ÁßªÈô§';
        removeBtn.addEventListener('click', () => {
            this.removeItemFromList(item.id);
        });
        
        div.appendChild(removeBtn);
        
        return div;
    }

    removeItemFromList(itemId) {
        this.listManager.removeFromList(this.currentListId, itemId);
        this.updateListDisplay();
        this.updateDisplay(); // Êõ¥Êñ∞Â∑¶ÂÅ¥È°ØÁ§∫
        this.showNotification('Â∑≤ÂæûÊ∏ÖÂñÆÁßªÈô§', 'info');
    }

    loadLists() {
        const lists = this.listManager.getAllLists();
        this.renderListTabs(lists);
        
        if (lists.length > 0) {
            this.switchToList(lists[0].id);
        }
    }

    renderListTabs(lists) {
        const container = this.elements.listTabs;
        container.innerHTML = '';
        
        lists.forEach(list => {
            const tab = document.createElement('button');
            tab.className = 'list-tab';
            tab.dataset.listId = list.id;
            tab.textContent = list.name;
            
            if (list.id === this.currentListId) {
                tab.classList.add('active');
            }
            
            tab.addEventListener('click', () => {
                this.switchToList(list.id);
            });
            
            container.appendChild(tab);
        });
    }

    switchToList(listId) {
        this.currentListId = listId;
        const list = this.listManager.getList(listId);
        
        if (list) {
            this.elements.currentListName.textContent = list.name;
            
            // Êõ¥Êñ∞Ê®ôÁ±§È†ÅÁãÄÊÖã
            this.elements.listTabs.querySelectorAll('.list-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.listId === listId);
            });
            
            // Êõ¥Êñ∞Ê∏ÖÂñÆÈ°ØÁ§∫
            this.updateListDisplay();
            
            // Êõ¥Êñ∞Â∑¶ÂÅ¥È†ÖÁõÆÈ°ØÁ§∫
            this.updateDisplay();
        }
    }

    showNewListDialog() {
        if (this.listManager.getAllLists().length >= TimedGatheringManager.CONSTANTS.MAX_LISTS) {
            this.showNotification(`ÊúÄÂ§öÂè™ËÉΩÂª∫Á´ã ${TimedGatheringManager.CONSTANTS.MAX_LISTS} ÂÄãÊ∏ÖÂñÆ`, 'warning');
            return;
        }
        
        this.elements.dialogTitle.textContent = 'Êñ∞Â¢ûÊ∏ÖÂñÆ';
        this.elements.dialogBody.innerHTML = `
            <div class="form-group">
                <label for="newListName">Ê∏ÖÂñÆÂêçÁ®±Ôºö</label>
                <input type="text" id="newListName" class="form-control" 
                       placeholder="Ëº∏ÂÖ•Ê∏ÖÂñÆÂêçÁ®±" maxlength="${TimedGatheringManager.CONSTANTS.MAX_LIST_NAME_LENGTH}">
            </div>
        `;
        
        this.elements.dialogConfirm.onclick = () => {
            const input = document.getElementById('newListName');
            const name = input.value.trim();
            
            if (name) {
                const result = this.listManager.createList(name);
                if (result.success) {
                    this.loadLists();
                    this.switchToList(result.listId);
                    this.hideDialog();
                    this.showNotification('Ê∏ÖÂñÆÂ∑≤Âª∫Á´ã', 'success');
                } else {
                    this.showNotification(result.message, 'error');
                }
            }
        };
        
        this.showDialog();
        
        // Ëá™ÂãïËÅöÁÑ¶Ëº∏ÂÖ•Ê°Ü
        setTimeout(() => {
            document.getElementById('newListName').focus();
        }, 100);
    }

    showRenameListDialog() {
        const currentList = this.listManager.getList(this.currentListId);
        
        this.elements.dialogTitle.textContent = 'ÈáçÊñ∞ÂëΩÂêçÊ∏ÖÂñÆ';
        this.elements.dialogBody.innerHTML = `
            <div class="form-group">
                <label for="renameListInput">Êñ∞ÂêçÁ®±Ôºö</label>
                <input type="text" id="renameListInput" class="form-control" 
                       value="${currentList.name}" maxlength="${TimedGatheringManager.CONSTANTS.MAX_LIST_NAME_LENGTH}">
            </div>
        `;
        
        this.elements.dialogConfirm.onclick = () => {
            const input = document.getElementById('renameListInput');
            const newName = input.value.trim();
            
            if (newName && newName !== currentList.name) {
                const result = this.listManager.renameList(this.currentListId, newName);
                if (result.success) {
                    this.loadLists();
                    this.elements.currentListName.textContent = newName;
                    this.hideDialog();
                    this.showNotification('Ê∏ÖÂñÆÂ∑≤ÈáçÊñ∞ÂëΩÂêç', 'success');
                } else {
                    this.showNotification(result.message, 'error');
                }
            }
        };
        
        this.showDialog();
        
        // Ëá™ÂãïÈÅ∏ÂèñÊñáÂ≠ó
        setTimeout(() => {
            const input = document.getElementById('renameListInput');
            input.select();
        }, 100);
    }

    showDeleteListDialog() {
        const lists = this.listManager.getAllLists();
        
        if (lists.length <= 1) {
            this.showNotification('Ëá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏ÄÂÄãÊ∏ÖÂñÆ', 'warning');
            return;
        }
        
        const currentList = this.listManager.getList(this.currentListId);
        
        this.elements.dialogTitle.textContent = 'Âà™Èô§Ê∏ÖÂñÆ';
        this.elements.dialogBody.innerHTML = `
            <p>Á¢∫ÂÆöË¶ÅÂà™Èô§Ê∏ÖÂñÆ„Äå${currentList.name}„ÄçÂóéÔºü</p>
            <p class="text-danger">Ê≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ</p>
        `;
        
        this.elements.dialogConfirm.onclick = () => {
            const result = this.listManager.deleteList(this.currentListId);
            if (result.success) {
                const remainingLists = this.listManager.getAllLists();
                this.loadLists();
                if (remainingLists.length > 0) {
                    this.switchToList(remainingLists[0].id);
                }
                this.hideDialog();
                this.showNotification('Ê∏ÖÂñÆÂ∑≤Âà™Èô§', 'success');
            } else {
                this.showNotification(result.message, 'error');
            }
        };
        
        this.showDialog();
    }

    clearCurrentList() {
        const list = this.listManager.getList(this.currentListId);
        
        if (!list || list.items.length === 0) {
            this.showNotification('Ê∏ÖÂñÆÂ∑≤Á∂ìÊòØÁ©∫ÁöÑ', 'info');
            return;
        }
        
        this.elements.dialogTitle.textContent = 'Ê∏ÖÁ©∫Ê∏ÖÂñÆ';
        this.elements.dialogBody.innerHTML = `
            <p>Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫Ê∏ÖÂñÆ„Äå${list.name}„ÄçÂóéÔºü</p>
            <p>Â∞áÁßªÈô§ ${list.items.length} ÂÄãÊé°ÈõÜÁâ©</p>
        `;
        
        this.elements.dialogConfirm.onclick = () => {
            this.listManager.clearList(this.currentListId);
            this.updateListDisplay();
            this.updateDisplay();
            this.hideDialog();
            this.showNotification('Ê∏ÖÂñÆÂ∑≤Ê∏ÖÁ©∫', 'success');
        };
        
        this.showDialog();
    }

    generateMacro() {
        const list = this.listManager.getList(this.currentListId);
        
        if (!list || list.items.length === 0) {
            this.showNotification('Ê∏ÖÂñÆÁÇ∫Á©∫ÔºåÁÑ°Ê≥ïÁîüÊàêÂ∑®ÈõÜ', 'warning');
            return;
        }
        
        const options = {
            includeClear: this.elements.includeClearCmd.checked,
            sortByTime: this.elements.sortByTime.checked
        };
        
        const macro = this.macroExporter.generate(list.items, options);
        
        this.elements.macroText.value = macro;
        this.elements.macroOutput.style.display = 'block';
        
        // ÊªæÂãïÂà∞Â∑®ÈõÜÂçÄÂüü
        this.elements.macroOutput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    copyMacroToClipboard() {
        const macroText = this.elements.macroText.value;
        
        if (!macroText) {
            this.showNotification('Ê≤íÊúâÂ∑®ÈõÜÂèØË§áË£Ω', 'warning');
            return;
        }
        
        navigator.clipboard.writeText(macroText).then(() => {
            this.showNotification('Â∑®ÈõÜÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø', 'success');
            
            // Êö´ÊôÇÊîπËÆäÊåâÈàïÊñáÂ≠ó
            const originalText = this.elements.copyMacroBtn.innerHTML;
            this.elements.copyMacroBtn.innerHTML = '<span class="btn-icon">‚úîÔ∏è</span> Â∑≤Ë§áË£ΩÔºÅ';
            setTimeout(() => {
                this.elements.copyMacroBtn.innerHTML = originalText;
            }, 2000);
        }).catch(err => {
            console.error('Ë§áË£ΩÂ§±Êïó:', err);
            this.showNotification('Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïÈÅ∏ÂèñË§áË£Ω', 'error');
        });
    }

    showImportDialog() {
        this.elements.dialogTitle.textContent = 'ÂåØÂÖ•Ê∏ÖÂñÆ';
        this.elements.dialogBody.innerHTML = `
            <div class="form-group">
                <label for="importFile">ÈÅ∏ÊìáÊ™îÊ°àÔºö</label>
                <input type="file" id="importFile" class="form-control" accept=".json">
            </div>
            <p class="text-muted">Ë´ãÈÅ∏Êìá‰πãÂâçÂåØÂá∫ÁöÑ JSON Ê™îÊ°à</p>
        `;
        
        this.elements.dialogConfirm.onclick = () => {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (file) {
                this.importFile(file);
            }
        };
        
        this.showDialog();
    }

    importFile(file) {
        const reader = new FileReader();
        
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                const result = this.listManager.importLists(data);
                
                if (result.success) {
                    this.loadLists();
                    this.hideDialog();
                    this.showNotification(`ÊàêÂäüÂåØÂÖ• ${result.count} ÂÄãÊ∏ÖÂñÆ`, 'success');
                } else {
                    this.showNotification(result.message, 'error');
                }
            } catch (error) {
                console.error('ÂåØÂÖ•Â§±Êïó:', error);
                this.showNotification('Ê™îÊ°àÊ†ºÂºèÈåØË™§', 'error');
            }
        };
        
        reader.readAsText(file);
    }

    exportLists() {
        const data = this.listManager.exportLists();
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `ff14tw_timed_gathering_lists_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        URL.revokeObjectURL(url);
        
        this.showNotification('Ê∏ÖÂñÆÂ∑≤ÂåØÂá∫', 'success');
    }

    updateItemCount() {
        this.elements.itemCount.textContent = `(${this.filteredData.length} / ${this.data.length})`;
    }

    showDialog() {
        this.elements.dialogOverlay.style.display = 'flex';
    }

    hideDialog() {
        this.elements.dialogOverlay.style.display = 'none';
    }

    showLoading(show) {
        this.elements.loadingIndicator.style.display = show ? 'flex' : 'none';
        this.elements.itemsContainer.style.display = show ? 'none' : 'block';
    }

    showError(message) {
        this.elements.errorMessage.textContent = message;
        this.elements.errorMessage.style.display = 'block';
        this.elements.loadingIndicator.style.display = 'none';
        this.elements.itemsContainer.style.display = 'none';
    }

    showNotification(message, type = 'info') {
        // Âª∫Á´ãÈÄöÁü•ÂÖÉÁ¥†
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        
        // Âä†ÂÖ•Âà∞ body
        document.body.appendChild(notification);
        
        // È°ØÁ§∫ÂãïÁï´
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        // 3 ÁßíÂæåÁßªÈô§
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }
}

// È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', () => {
    new TimedGatheringManager();
});